# NAT-vps 终极 VPS 优化套件

[![Language](https://img.shields.io/badge/Language-Bash-blue.svg)](https://www.gnu.org/software/bash/)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](https://opensource.org/licenses/MIT)

本项目是一套为 Linux VPS 设计的终极性能优化脚本，旨在通过自动化和智能化的方式，最大化服务器的网络吞吐能力和系统综合性能。

### ✨ 项目理念
*   **安全第一**: 所有脚本默认以**预览模式 (Dry Run)** 运行，在您明确授权 (`--apply`) 前，绝不修改系统。
*   **智能适配**: 脚本会尝试自动检测您的系统环境（网络延迟、硬件配置），以应用最合适的优化参数。
*   **全面优化**: 不仅优化网络内核，更涵盖了**系统I/O、CPU调度、网卡硬件**等多个维度，实现真正的“系统级”性能提升。
*   **模块化设计**: 您可以像搭积木一样，自由选择需要的优化模块，满足个性化需求。

---

## 🚀 一键上手 (Quick Start)

> **重要**: 请始终以 `root` 用户身份执行。建议遵循 **“先优化网络，再优化系统”** 的顺序。

### 1. 网络专项优化 (`vps2.sh`)

此脚本是性能提升的核心，通过科学计算BDP来精细调校网络。

#### **第1步: 获取您真实的延迟(RTT)**
在**您自己的电脑**上 (而不是VPS上) 打开终端或CMD，执行 `ping` 命令：
```bash
ping <您的VPS IP地址>
```
记下返回的平均 `时间=` 或 `time=` 值，例如 `197ms`。

#### **第2步: 执行优化**
将下面命令中的 `197` 替换为您刚刚测得的真实延迟值。

```bash
# 推荐的标准模式
wget -O - https://raw.githubusercontent.com/jkrore/NAT-vps/main/vps2.sh | bash -s -- --apply --rtt 197

# 追求极致性能的激进模式 (有安全风险, 需要重启)
wget -O - https://raw.githubusercontent.com/jkrore/NAT-vps/main/vps2.sh | bash -s -- --apply --mode aggressive --rtt 197
```

### 2. 系统综合优化 (`vps.sh`)

此脚本作为补充，用于优化I/O、清理服务、安装实用工具等。

```bash
# 推荐的安全优化组合 (优化I/O + 安装动态调优服务 + 生成工具)
wget -O - https://raw.githubusercontent.com/jkrore/NAT-vps/main/vps.sh | bash -s -- --apply --apply-io-limits --install-hw-tuning --generate-tools
```

### 3. 重启服务器 (如果需要)
如果您在任何步骤中使用了 `aggressive` 模式或 `--apply-grub` 模块，**必须重启服务器**才能使所有设置生效。
```bash
sudo reboot
```

---

## 📖 脚本深度解析

### `vps2.sh` (网络专项优化脚本)

这是本套件的灵魂。它摒弃了固定的“魔法数值”，采用动态计算的方式为您的服务器量身定制网络参数。

#### 核心功能
*   **动态RTT检测**: 自动检测网络延迟，作为计算的基础。
*   **BDP科学计算**: 基于 **带宽 × 延迟** 精确计算出最佳TCP缓冲区大小。
*   **冲突自动处理**: 自动备份并禁用系统中可能存在的旧版、冲突的网络配置。
*   **三位一体优化**: 同时优化 **内核(`sysctl`) + 网卡硬件(`ethtool`) + CPU协同(`RPS/XPS`)**。
*   **安全与回滚**: 强制预览，并为每次修改生成一键回滚脚本。

#### 参数指南 (`--parameter`)

| 参数 | 作用 | 解释 |
| :--- | :--- | :--- |
| **(无参数)** | **安全预览** | 默认模式，只看不做，绝对安全。 |
| `--apply` | **确认应用** | 授权脚本开始修改您的系统。 |
| `--mode normal` | **标准模式** | 默认模式，应用BBR+FQ等标准网络优化。 |
| `--mode aggressive` | **激进模式** | 额外启用`cake`队列并尝试禁用CPU安全补丁，**需要重启**。 |
| `--rtt <毫秒>` | **指定延迟** | **最关键的参数**。强制脚本使用您测得的精确延迟值。 |
| `--iperf <IP>` | **性能测试** | 优化后，立即对指定的`iperf3`服务端IP进行带宽测试。 |
| `--rollback <路径>` | **执行回滚** | 从指定的备份目录恢复配置。 |

---

### `vps.sh` (系统综合优化脚本)

此脚本是 `vps2.sh` 的完美搭档，负责网络之外的系统级优化。它采用完全模块化的设计，您可以自由组合。

#### 模块化参数指南

| 参数 | 模块名称 | 风险等级 | 解释 |
| :--- | :--- | :--- | :--- |
| `--apply-io-limits` | I/O与资源限制 | **低** | 优化SSD/NVMe硬盘读写，大幅提升文件句柄数。**强烈推荐**。 |
| `--install-hw-tuning` | 硬件动态调优 | **中** | 安装后台服务，持续优化CPU频率和网卡缓冲区。**强烈推荐**。 |
| `--generate-tools` | 生成辅助工具 | **极低** | 创建两个实用的监控和基准测试脚本。 |
| `--cleanup-services` | 服务清理 | **高** | **禁用**大量常见服务，可能误关您需要的服务，请谨慎使用。 |
| `--apply-grub` | GRUB 优化 | **极高** | **仅限母鸡(Host)使用**，用于CPU隔离，普通VPS**绝对不要用**。 |
| `--apply-host-specifics` | 母鸡特定优化 | **高** | **仅限母鸡(Host)使用**，配置大页内存，普通VPS**不要用**。 |
| `--all` | 应用所有模块 | **极高** | 一键启用以上所有模块，请确保您了解其全部内容。 |

---

## 🛠️ 进阶指南

### 网页UI工具 (“TCP 迷之调参”)

您可能见过类似下图的网页工具。它是一个非常优秀的**参数计算器**，可以帮您直观地获得 `vps2.sh` 所需的核心参数。



*   **如何使用它**:
    1.  在您本地电脑 `ping` 您的服务器，得到精确的**网络延迟(ms)**。
    2.  在UI上填入您的**服务器带宽**、**网络延迟**等参数。
    3.  这个UI可以帮您直观地理解各项参数的作用，但我们**最终仍然推荐使用 `vps2.sh` 脚本来执行**，因为它提供了更深度的系统级优化（CPU+网卡）。
    4.  您可以将从UI上得到的参数，通过命令行参数（如`--rtt`）传递给 `vps2.sh` 脚本。

### 安全与回滚

*   **`vps2.sh`**:
    *   **备份目录**: `/var/backups/net-optimizer/`
    *   **回滚方法**: 每个备份目录内都有一个 `rollback.sh` 脚本。通过以下命令执行回滚：
      ```bash
      # 将路径替换成您的备份目录
      wget -O - https://raw.githubusercontent.com/jkrore/NAT-vps/main/vps2.sh | bash -s -- --apply --rollback /var/backups/net-optimizer/net-optimizer-xxxx
      ```

*   **`vps.sh`**:
    *   **备份目录**: `/root/ultimate_singularity_backups/`
    *   **回滚方法**: 手动恢复。进入对应的备份目录，找到被修改文件的备份（`.bak`后缀），手动将其复制回原位。

### 免责声明
本项目脚本旨在提升服务器性能，但任何系统层面的修改都伴随着风险。请在执行前确保您已备份重要数据。因使用本脚本造成的任何问题，作者不承担任何责任。
