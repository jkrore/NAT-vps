
# 终极 VPS 优化套件

本文件详细解释了两个强大的 shell 脚本，旨在优化虚拟专用服务器（VPS）：`vps1.sh`和`vps2.sh`。第一个脚本`vps1.sh`专注于系统级优化，而`vps2.sh`则致力于精细调整网络性能。

## `vps1.sh`: 系统级优化

`vps1.sh` 是一个全面的脚本，它应用了超越核心网络调优的系统级增强。该脚本设计为模块化，允许您仅应用所需的优化。默认情况下，该脚本包含“干运行”模式，以确保您可以在更改之前审查所有更改。

### 主要功能

*   **环境检测**：自动检测操作系统、CPU 数量、内存和虚拟化类型，以确定机器的角色（`host`、`nat` 或 `guest`）。
*   **模块化设计**：优化措施被分组为模块，可以单独应用或一次性全部应用。
*   **安全优先**：默认为干运行模式，仅打印将要执行的操作。需要使用 `--apply` 标志才能进行实际修改。
*   **自动备份**：在修改任何配置文件之前，脚本会在 `/root/ultimate_singularity_backups` 目录下创建带时间戳的备份文件。

### 如何使用

1. **预览所有操作**：
    ```bash
    ./vps1.sh --all
    ```
2.  **预览单个模块的操作**：
    ```bash
    ./vps1.sh --apply-io-limits
    ```
3.  **应用单个模块**：
    ```bash
    ./vps1.sh --apply --apply-io-limits
    ```
4. **应用所有模块**：
    ```bash
    ./vps1.sh --apply --all
    ```

### 优化模块

| 模块 | 描述 | 风险等级 |
| --- | --- | --- |
| `--apply-io-limits` | 优化 NVMe/SSD 驱动的存储 I/O 调度器，并增加系统范围内的打开文件和进程的资源限制。 | 低 |
| `--cleanup-services` | 禁用服务器上通常不必要的服务，例如 `bluetooth`、`cups` 和 `snapd`。**注意**：这是一个高风险操作，可能会禁用您需要的服务。 | 高 |
| `--apply-grub` | 将 CPU 隔离和其他与性能相关的内核参数应用于 GRUB 配置。此操作适用于“主机”机器，可能非常危险。**更改需要重启才能生效。** | 非常高 |
| `--apply-host-specifics` | 为内存配置大页面，这是针对“主机”机器的另一种优化。 | 中等 |
| `--generate-tools` | 创建两个有用的脚本：`ultimate-monitor.sh` 用于快速系统概览和 `ultimate-bench.sh` 用于简单的性能测试。 | 低 |
| `--install-hw-tuning` | 安装并启用一个 systemd 服务，该服务每 300 秒动态调整硬件参数（如 CPU 治理和网络接口缓冲区）。 | 中等 |

## `vps2.sh`: 网络性能优化器

`vps2.sh` 是一个复杂的脚本，旨在通过根据服务器的特定网络条件调整 `sysctl` 参数来优化网络性能。它计算带宽延迟积（BDP）以设置最佳缓冲区大小，旨在最大化吞吐量。

### 主要功能

*   **动态 RTT 检测**：自动测量与连接的 SSH 客户端或公共服务器的往返时间 (RTT)，以精确调整网络参数。
*   **BDP 计算**：计算 BDP 以确定连接的理想 TCP 缓冲区大小。
*   **冲突解决**：扫描并禁用 `/etc/sysctl.conf` 和 `/etc/sysctl.d/` 中的冲突网络设置，以确保其自身设置正确应用。
*   **回滚功能**：创建所有修改文件的备份，并生成 `rollback.sh` 脚本以便轻松恢复。
*   **模式**: 提供一个 `normal` 模式用于安全有效的调整，以及一个 `aggressive` 模式用于更极端的优化。

### 如何使用

1.  **预览更改（干运行）**:
    ```bash
./vps2.sh --dry-run
    ```
2.  **应用优化**：
    ```bash
./vps2.sh --apply
    ```
3.  **使用激进模式（需谨慎）**：
    ```bash
./vps2.sh --apply --mode aggressive
    ```
4.  **手动指定 RTT（如果检测不准确）**：
    ```bash
./vps2.sh --apply --rtt 120
    ```
5.  **回滚到先前状态**：
    ```bash
./vps2.sh --apply --rollback /var/backups/net-optimizer/net-optimizer-YYYY-MM-DD-HHMMSS
    ```

### 核心优化

*   **TCP 拥塞控制**：将拥塞控制算法设置为 BBR，并使用 FQ 数据包调度器，这对现代网络非常有效。
*   **缓冲区大小调整**：根据 BDP 动态计算并设置 TCP 读写内存限制。
*   **网卡调优**：调整网络接口卡（NIC）设置，包括接收端扩展（RPS）和发送包转向（XPS），以在多个 CPU 核心上分配网络处理。
*   **DNS 优化**：配置系统使用快速可靠的公共 DNS 服务器（1.1.1.1，8.8.8.8）。
*   **激进模式**：在此模式下，脚本还会修改 GRUB 以禁用 CPU 漏洞缓解措施（`mitigations=off`），这可以提高性能，但也存在安全风险。

## 关于 `vps.sh` 的说明

文件 `vps.sh` 存在于仓库中，但在提示中未提供。因此，它不包含在此文档中。
