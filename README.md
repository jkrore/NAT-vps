
# 终极 VPS 优化套件：详细指南

本文档详细解析了来自`jkrore/NAT-vps`仓库中的三个强大 shell 脚本：`vps.sh`、`vps1.sh`和`vps2.sh`。这些脚本旨在对基于 Linux 的虚拟专用服务器（VPS）应用广泛的系统和网络优化。

## 脚本哲学

脚本基于模块化和安全优先的原则运行。关键概念包括：
*   **干运行模式**：默认情况下，脚本仅显示它们*将要*做出的更改。您必须明确使用`--apply`标志来修改系统。
*   **自动备份**：在更改任何配置文件之前，会创建带时间戳的备份，并通常会生成回滚脚本。
*   **智能检测**：脚本尝试检测服务器环境（CPU、内存、网络状况、角色）以应用定制优化。

---

## `vps.sh` / `vps1.sh`：系统级优化

`vps.sh` 和 `vps1.sh` 是相同的脚本，专注于超出核心网络调优的系统级增强。它被描述为“补充模块脚本”，旨在提供原始“终极奇点”套件中的优化，这些优化未被专注于网络的 `vps2.sh` 所涵盖。

### 目的
通过调整 I/O、清理不必要的服务、针对特定角色（如虚拟化主机）优化内核，以及安装用于监控和动态调优的工具来提升整体系统性能。

### 使用方法

该脚本模块化，允许您选择要应用哪些优化。

| 参数 | 描述 |
| :--- | :--- |
| `--apply` | 应用更改。没有这个参数，脚本将在"干运行"模式下运行。 |
| `--all` | 选择所有可用的优化模块。 |
| `--apply-io-limits` | 应用 I/O 和系统资源限制优化。 |
| `--cleanup-services` | **(高风险)** 禁用一组常见且通常不需要的服务。 |
| `--apply-grub` | **(极高风险)** 修改 CPU 隔离的引导加载程序设置。适用于主机系统。 |
| `--apply-host-specifics` | 对主机系统应用优化，如大内存页。 |
| `--generate-tools` | 创建简单的监控和基准测试脚本。 |
| `--install-hw-tuning` | 安装一个用于动态硬件调优的服务。 |
| `-h`, `--help` | 显示帮助信息。 |

**示例：**
```bash
# 预览所有更改但不应用它们
./vps.sh --all

# 仅应用 I/O 和限制优化
```
./vps.sh --apply --apply-io-limits
```

### 模块详细分解

#### 1. 环境检测
在应用任何更改之前，脚本会分析系统以确定其 `角色`：
*   **`nat`**: 如果 `ip_forward` 已启用或检测到 `iptables`/`nftables` 中的 NAT 规则。
*   **`host`**: 如果它是一台裸金属机器（`systemd-detect-virt` 返回 `none`），具有 KVM 支持，并且至少有 4GB 内存。这是一台用于托管虚拟机的机器。
*   **`guest`**: 标准 VPS 的默认角色。

这个角色确定对于 GRUB 和 Huge Pages 等特定角色的模块至关重要。

#### 2. I/O 和限制 (`--apply-io-limits`)
*   **资源限制**：创建`/etc/security/limits.d/99-ultimate-singularity.conf`以大幅增加最大打开文件数(`nofile`)至 200 万以上。这对于处理大量并发连接的高流量服务器和应用至关重要。
*   **I/O 调度器**：创建`/etc/udev/rules.d/60-ultimate-io.rules`以优化 I/O 调度器。
*   对于 NVMe 驱动器，它将调度器设置为`none`，这是理想的，因为设备足够快，不需要内核级别的请求重新排序。
    *   对于 SSD（`rotational`="0"），它将调度器设置为`mq-deadline`，这是一种现代的低延迟调度器，适合快速存储。
    *   它还增加了正在处理的请求数量（`nr_requests`）到`1024`，以提高吞吐量。

#### 3. 服务清理（`--cleanup-services`）
这个高风险模块禁用并停止了在专用服务器上通常不必要的一组服务和计时器，从而释放了内存和 CPU 周期。
*   **常见服务**： `irqbalance`, `tuned`, `thermald`, `bluetooth`, `cups`, `snapd`, `unattended-upgrades`, `rsyslog`, `auditd`, `cron`.
*   **网络服务**： `firewalld`, `ufw`, `nftables`（如果角色不是`nat`则禁用）。
*   **虚拟化服务**： `libvirtd`, `virtlogd`（如果角色不是`host`则禁用）。
*   **内核模块**: 黑名单模块如 `bluetooth` 和 `pcspkr`，以防止它们加载。

#### 4. GRUB 优化 (`--apply-grub`)
这个非常高风险的模块仅适用于**主机角色**。它修改 `/etc/default/grub` 以隔离四分之一的 CPU 核心用于主机进程，减少操作系统抖动，并将剩余核心分配给虚拟机。
*   **`isolcpus`**: 将指定的 CPU 从内核调度器的通用控制中移除。
*   **`nohz_full`**: 防止内核的定时器中断隔离的 CPU，从而降低延迟。
*   **`rcu_nocbs`**: 将 RCU 回调从隔离的 CPU 卸载。
*   **`idle=poll`**: 防止 CPU 进入深度睡眠状态，以牺牲功耗换取更低延迟。
*   **这些更改需要重启才能生效。**

#### 5. 主机特定配置 (`--apply-host-specifics`)
同样，仅对**主机角色**而言，此模块配置内存中的"大页"。标准内存以 4KB 页面进行管理；大页使用更大的块（例如 2MB 或 1GB）。对于虚拟化，这减少了虚拟机内存管理的开销，从而提高性能。

#### 6. 硬件调优服务 (`--install-hw-tuning`)
此模块安装一个脚本和一个`systemd`计时器，每 5 分钟运行一次该脚本。该脚本执行动态优化：
*   **CPU Governor**: 将 CPU 频率调节器设置为 `performance`，强制 CPU 以最高时钟速度运行，以获得稳定的性能。
*   **Dynamic NIC Buffers**: 它测量每个接口的网络流量速度。根据速度，使用 `ethtool` 动态调整 RX/TX 环缓冲区的大小。较大的缓冲区可以在高流量突发期间防止数据包丢失。
*   **Disables Offloads**: 它禁用某些网络卸载功能，如 GSO、GRO、TSO 和 LRO，这些功能有时可能会引入延迟。

---

## `vps2.sh`: 网络性能优化器

`vps2.sh` 是一个高度专业化的脚本，专注于优化网络吞吐量和延迟。它采用基于**带宽-延迟积（BDP）**的科学方法来配置 Linux 网络栈。

### 目的
自动调整内核网络参数（`sysctl`），以匹配服务器互联网连接的特性，从而最大化速度和可靠性。

### 使用方法

| 参数 | 描述 |
| :--- | :--- |
| `--apply` | 应用更改。默认为 `--dry-run` |
| `--mode normal\|aggressive` | `normal` 是默认模式。`aggressive` 会应用更危险的 GRUB 编辑来禁用 CPU 缓解措施。 |
| `--rtt <ms>` | 手动强制设置往返时间（RTT）值（单位为毫秒），覆盖自动检测。 |
| `--iperf <ip1,ip2>` | 在应用设置后，对指定服务器运行 `iperf3` 测试以测量带宽。 |
| `--install-service` | （提供的脚本中未完全实现）旨在安装一个持久服务。 |
| `--rollback <backupdir>` | 使用指定的备份目录回滚更改。执行时需要 `--apply`。 |
| `-q`, `--quiet` | 减少输出量。 |

**示例：**
```bash
# 预览激进设置的网络优化
./vps2.sh --dry-run --mode aggressive

# 应用优化，手动设置 RTT 为 80ms
./vps2.sh --apply --rtt 80
```

### 操作的详细分解

#### 1. RTT 和 BDP 计算
这是脚本的核心。
1. **RTT 检测**：脚本按特定顺序确定网络延迟（RTT）：
    1. 如果提供了`--rtt`参数，则使用该值。
    2. 尝试获取当前 SSH 会话的 IP 地址（`$SSH_CONNECTION`）并对其进行 ping 操作。
    3. 如果失败，则回退到 ping 一个可靠的公共服务器（`1.1.1.1`）。
4.  如果检测到的 RTT 可疑地低（< 5ms），则会被丢弃。
2.  **BDP 计算**：它使用公式`BDP（字节）= 带宽（Mbps）* 125 * RTT（ms）`来计算带宽时延积。BDP 表示在任何时刻网络上可以“在途”的最大数据量。
3.  **缓冲区大小设置**：最佳的 TCP 缓冲区大小与时延积直接相关。脚本将最大缓冲区大小限制为这三个值中最小的一个，以防止内存使用过度：
    *   `2 * BDP`
*   `总系统内存的3%`
    *   `64 MB`
    然后使用这个最终值来设置内核的 TCP 内存限制。

#### 2. 冲突清理和备份
在应用任何设置之前，脚本确保有一个干净的起点：
*   它在 `/var/backups/net-optimizer/` 创建一个备份目录。
*   它扫描 `/etc/sysctl.conf` 和 `/etc/sysctl.d/` 中的所有文件，查找与其自身冲突的设置（例如，`net.ipv4.tcp_congestion_control`）。
*   `/etc/sysctl.conf` 中的冲突行被注释掉。
*   `/etc/sysctl.d/`目录中的冲突文件被重命名为`.disabled_by_optimizer`。
*   在备份目录中生成一个`rollback.sh`脚本，以便轻松撤销这些更改。

#### 3. 系统控制配置
脚本在`/etc/sysctl.d/`目录中生成并应用一个新的系统控制配置文件`999-net-optimizer.conf`。关键参数包括：
*   **拥塞控制**：默认设置为 `bbr` 并使用 `fq`（公平队列）数据包调度。BBR 是 Google 开发的一种现代算法，旨在优化现代网络中的吞吐量。
*   **TCP/内核缓冲区**：根据 BDP 计算结果设置 `net.core.rmem_max`、`net.core.wmem_max`、`net.ipv4.tcp_rmem` 和 `net.ipv4.tcp_wmem`。这是最关键的调整步骤。
*   **TCP 行为**：启用现代 TCP 功能，如 `tcp_mtu_probing`（用于发现最佳 MTU）、`tcp_fastopen` 和 `tcp_window_scaling`。
*   **虚拟机/内核设置**：对虚拟内存设置如 `vm.swappiness` 和 `vm.vfs_cache_pressure` 进行微调，以优先将应用数据保留在内存中。

#### 4. NIC 和 CPU 调优
*   **卸载功能**: 通过`ethtool`在网卡上启用常见硬件卸载功能（`tso`、`gso`、`gro`），以减少 CPU 负载。
*   **RPS/XPS**: 配置接收包调度和发送包调度。这会将处理网络数据包的工作负载分配到可用的前半部分 CPU 核心上，防止单个核心成为瓶颈。
*   **中断亲和性**: 尝试将网卡硬件中断请求（IRQ）分配到不同的 CPU 核心，进一步分散负载。
*   **CPU Governor**: 将 CPU governor 设置为`performance`以获得最大、一致的时钟速度。

#### 5. 运行时自适应调整
应用初始设置后，脚本执行一次性检查，以查看是否需要立即调整。
*   它监控 TCP 重传率和当前网络利用率。
*   如果重传率高（>2%），它假定缓冲区可能过大，导致丢包，因此将缓冲区减少10%。
*   如果网络利用率低（<30%），它假定有更多空间进行更激进的缓冲，因此将缓冲区增加10%。

#### 6. 激进模式 (`--mode aggressive`)
如果选择此模式，脚本将修改 `/etc/default/grub` 以添加内核参数，禁用针对 Spectre 和 Meltdown 等漏洞的各种 CPU 安全缓解措施（`mitigations=off`、`noibrs`、`nopti` 等）。
*   **警告**：这可以提供显著的性能提升，特别是对于虚拟化和 I/O 密集型工作负载，但它以禁用重要安全功能为代价。**需要重启。**
