bash <(cat <<EOF
#!/bin/bash
# ==============================================================================
#   ğŸ’ TikTok ç›´æ’­èŠ‚ç‚¹ï¼šå…¨èƒ½è¡¥å…¨ä¸äº¤ä»˜ç³»ç»Ÿ (The Final One)
#   åŠŸèƒ½ï¼šDNSé” + NSCDç¼“å­˜ + MSSé’³åˆ¶/QUICé˜»æ–­ + é“¾è·¯é¢„çƒ­ + è¿›ç¨‹ææƒ
# ==============================================================================

# --- UI é¢œè‰²å®šä¹‰ ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BLUE='\033[0;34m'
NC='\033[0m'

# --- è¿›åº¦å‡½æ•° ---
step() { echo -e "\n\${YELLOW}>>> æ­£åœ¨éƒ¨ç½²æ¨¡å—ï¼š\$1 ...\${NC}"; }
success() { echo -e "\${GREEN}   [å®Œæˆ âœ…] \$1\${NC}"; }

clear
echo -e "\${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\${NC}"
echo -e "\${BLUE}â•‘      ğŸš€ TikTok ç›´æ’­èŠ‚ç‚¹ï¼šäº”ç»´ä¸€ä½“ç»ˆæä¼˜åŒ–ç³»ç»Ÿ v4.0           â•‘\${NC}"
echo -e "\${BLUE}â•‘      --------------------------------------------------      â•‘\${NC}"
echo -e "\${BLUE}â•‘      1. é˜²ç›—é—¨ (DNS Lock)      2. åŠ é€Ÿå™¨ (NSCD)              â•‘\${NC}"
echo -e "\${BLUE}â•‘      3. äº¤é€šç®¡åˆ¶ (IPTables)    4. è‡ªåŠ¨ç©ºè°ƒ (Warm-up)         â•‘\${NC}"
echo -e "\${BLUE}â•‘      5. VIPé€šé“ (Renice)                                     â•‘\${NC}"
echo -e "\${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\${NC}"
echo ""

# 0. å®‰è£…åŸºç¡€ä¾èµ–
step "å®‰è£…å¿…å¤‡åº•å±‚å·¥å…·"
apt update -y >/dev/null 2>&1
DEBIAN_FRONTEND=noninteractive apt install -y nscd iptables-persistent dnsutils e2fsprogs curl cron >/dev/null 2>&1
success "å·¥å…·é“¾å‡†å¤‡å®Œæ¯•"

# =======================================================
# 1. é˜²ç›—é—¨ (DNS Lock) + 2. åŠ é€Ÿå™¨ (NSCD)
# =======================================================
step "é…ç½®æœ¬åœ° DNS ç¼“å­˜ä¸ç‰©ç†é”å®š"

# é…ç½® NSCD
sed -i 's/enable-cache\s\+hosts\s\+no/enable-cache hosts yes/' /etc/nscd.conf
systemctl enable nscd >/dev/null 2>&1
systemctl restart nscd >/dev/null 2>&1

# é”å®š DNS æ–‡ä»¶
chattr -i /etc/resolv.conf >/dev/null 2>&1
echo "nameserver 1.1.1.1" > /etc/resolv.conf
echo "nameserver 8.8.8.8" >> /etc/resolv.conf
chattr +i /etc/resolv.conf >/dev/null 2>&1

success "DNS å·²ç„Šæ­» (1.1.1.1) ä¸” NSCD ç¼“å­˜å·²å¯åŠ¨ (0ms è§£æ)"

# =======================================================
# 3. äº¤é€šç®¡åˆ¶ (IPTables: MSS 1360 + Block QUIC)
# =======================================================
step "å®æ–½ç½‘ç»œäº¤é€šç®¡åˆ¶ (MSSé’³åˆ¶ + QUICå°æ€)"

# æ¸…ç†æ—§è§„åˆ™é˜²æ­¢é‡å¤
iptables -t mangle -D OUTPUT -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --set-mss 1360 2>/dev/null
iptables -t mangle -D FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --set-mss 1360 2>/dev/null
iptables -D OUTPUT -p udp --dport 443 -j DROP 2>/dev/null
iptables -D FORWARD -p udp --dport 443 -j DROP 2>/dev/null

# æ·»åŠ  MSS 1360 (é…åˆæ‰‹æœºç«¯ MTU 1400)
iptables -t mangle -A OUTPUT -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --set-mss 1360
iptables -t mangle -A FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --set-mss 1360

# æ·»åŠ  QUIC é˜»æ–­ (å¼ºåˆ¶ TCP)
iptables -A OUTPUT -p udp --dport 443 -j DROP
iptables -A FORWARD -p udp --dport 443 -j DROP

# æŒä¹…åŒ–ä¿å­˜
netfilter-persistent save >/dev/null 2>&1
success "MSS å·²é’³åˆ¶ä¸º 1360ï¼ŒUDP 443 (QUIC) å·²ç‰©ç†é˜»æ–­"

# =======================================================
# 4. è‡ªåŠ¨ç©ºè°ƒ (Warm-up Pro)
# =======================================================
step "éƒ¨ç½²å…¨é“¾è·¯æ™ºèƒ½é¢„çƒ­ç³»ç»Ÿ"

SCRIPT_PATH="/usr/local/bin/warmup_pro.sh"
cat > "\$SCRIPT_PATH" <<'INNER_EOF'
#!/bin/bash
# TikTok ç›´æ’­èŠ‚ç‚¹ä¸“ç”¨é¢„çƒ­è„šæœ¬
LOG_FILE="/var/log/warmup.log"
MAX_LOG_LINES=500
TARGETS=("www.google.com" "www.youtube.com" "www.tiktok.com" "github.com" "api.github.com")

# æ—¥å¿—æ¸…ç†
[ -f "\$LOG_FILE" ] && tail -n \$MAX_LOG_LINES "\$LOG_FILE" > "\$LOG_FILE.tmp" && mv "\$LOG_FILE.tmp" "\$LOG_FILE"

echo "Run: \$(date)" >> \$LOG_FILE
for domain in "\${TARGETS[@]}"; do
    # 1. å¼ºåˆ¶åˆ·æ–° NSCD ç¼“å­˜
    dig +short \$domain @1.1.1.1 >/dev/null 2>&1
    # 2. æ¨¡æ‹Ÿ TLS æ¡æ‰‹ (é¢„çƒ­ TCP è¿æ¥)
    curl -o /dev/null -s --connect-timeout 2 "https://\$domain"
done
INNER_EOF

chmod +x "\$SCRIPT_PATH"
# å†™å…¥è®¡åˆ’ä»»åŠ¡
crontab -l 2>/dev/null | grep -v "warmup_pro.sh" | crontab -
(crontab -l 2>/dev/null; echo "* * * * * \$SCRIPT_PATH >/dev/null 2>&1") | crontab -

success "é¢„çƒ­è„šæœ¬å·²éƒ¨ç½² (æ¯åˆ†é’Ÿè‡ªåŠ¨çƒ­èº«)"

# =======================================================
# 5. VIP é€šé“ (Renice Xray/Sing-box)
# =======================================================
step "éƒ¨ç½²èŠ‚ç‚¹è¿›ç¨‹ VIP ææƒå®ˆæŠ¤"

BOOST_PATH="/usr/local/bin/boost_proxy.sh"
cat > "\$BOOST_PATH" <<'INNER_EOF'
#!/bin/bash
# ä¸“ä¸º Xray / Sing-box è®¾è®¡çš„ææƒè„šæœ¬
TARGETS="xray|sing-box"
PIDS=\$(pgrep -f "\$TARGETS" | grep -v \$\$)

if [ -n "\$PIDS" ]; then
    for PID in \$PIDS; do
        # CPU ä¼˜å…ˆçº§æœ€é«˜ (-20)
        renice -n -20 -p \$PID >/dev/null 2>&1
        # IO ä¼˜å…ˆçº§å®æ—¶ (Realtime)
        ionice -c 1 -n 0 -p \$PID >/dev/null 2>&1
    done
fi
INNER_EOF

chmod +x "\$BOOST_PATH"
crontab -l 2>/dev/null | grep -v "boost_proxy.sh" | crontab -
(crontab -l 2>/dev/null; echo "* * * * * \$BOOST_PATH >/dev/null 2>&1") | crontab -

success "VIP ææƒå®ˆæŠ¤å·²å¯åŠ¨ (Xray/Sing-box ç‹¬å èµ„æº)"

# =======================================================
# 6. é¢å¤–èµ é€ï¼šæ—¥å¿—æ¸…ç†
# =======================================================
step "éƒ¨ç½²ç³»ç»Ÿæ—¥å¿—è‡ªåŠ¨æ¸…ç†"
cat > /etc/cron.daily/cleanup_logs <<INNER
#!/bin/bash
journalctl --vacuum-size=500M >/dev/null 2>&1
apt-get clean >/dev/null 2>&1
INNER
chmod +x /etc/cron.daily/cleanup_logs
success "æ—¥å¿—è‡ªåŠ¨æ¸…ç†å·²éƒ¨ç½²"

# ==============================================================================
#   ğŸ“Š æœ€ç»ˆäº¤ä»˜éªŒæ”¶ (Verification)
# ==============================================================================
clear
echo -e "\n\${YELLOW}============================================================\${NC}"
echo -e "           ğŸ† æœ€ç»ˆäº¤ä»˜éªŒæ”¶æŠ¥å‘Š (Verification)"
echo -e "\${YELLOW}============================================================\${NC}"

# 1. éªŒè¯ DNS é”
if [[ \$(lsattr /etc/resolv.conf) == *"i"* ]]; then
    printf "%-35s %s\n" "1. é˜²ç›—é—¨ (DNS Lock)" "\${GREEN}[å·²é”æ­» âœ…]\${NC}"
else
    printf "%-35s %s\n" "1. é˜²ç›—é—¨ (DNS Lock)" "\${RED}[æœªé”å®š âŒ]\${NC}"
fi

# 2. éªŒè¯ NSCD
if systemctl is-active --quiet nscd; then
    printf "%-35s %s\n" "2. åŠ é€Ÿå™¨ (NSCD Cache)" "\${GREEN}[è¿è¡Œä¸­ âœ…]\${NC}"
else
    printf "%-35s %s\n" "2. åŠ é€Ÿå™¨ (NSCD Cache)" "\${RED}[æœªè¿è¡Œ âŒ]\${NC}"
fi

# 3. éªŒè¯ é˜²ç«å¢™
if iptables -t mangle -L OUTPUT -n | grep -q "TCPMSS set 1360" && iptables -L OUTPUT -n | grep -q "udp dpt:443"; then
    printf "%-35s %s\n" "3. äº¤é€šç®¡åˆ¶ (MSS+QUIC)" "\${GREEN}[å·²ç”Ÿæ•ˆ âœ…]\${NC}"
else
    printf "%-35s %s\n" "3. äº¤é€šç®¡åˆ¶ (MSS+QUIC)" "\${RED}[ç¼ºå¤± âŒ]\${NC}"
fi

# 4. éªŒè¯ é¢„çƒ­
if crontab -l | grep -q "warmup_pro.sh"; then
    printf "%-35s %s\n" "4. è‡ªåŠ¨ç©ºè°ƒ (Warm-up)" "\${GREEN}[å·²éƒ¨ç½² âœ…]\${NC}"
else
    printf "%-35s %s\n" "4. è‡ªåŠ¨ç©ºè°ƒ (Warm-up)" "\${RED}[ç¼ºå¤± âŒ]\${NC}"
fi

# 5. éªŒè¯ ææƒ
if crontab -l | grep -q "boost_proxy.sh"; then
    printf "%-35s %s\n" "5. VIPé€šé“ (Xray Renice)" "\${GREEN}[å·²éƒ¨ç½² âœ…]\${NC}"
else
    printf "%-35s %s\n" "5. VIPé€šé“ (Xray Renice)" "\${RED}[ç¼ºå¤± âŒ]\${NC}"
fi

echo -e "\n\${CYAN}------------------------------------------------------------\${NC}"
echo -e "\${GREEN}ğŸ‰ æ­å–œï¼äº”ç»´ä¸€ä½“ä¼˜åŒ–å·²å…¨éƒ¨è½åœ°ã€‚VPS å·²è¾¾äº¤ä»˜æ ‡å‡†ã€‚\${NC}"
echo -e "\${CYAN}============================================================\${NC}"
EOF
)














bash <(cat <<EOF
#!/bin/bash
# ======================================================================
#   ğŸ† TikTok ç›´æ’­èŠ‚ç‚¹ï¼šå…¨ç»´åº¦ç»ˆæéªŒæ”¶å®¡è®¡ (Ultimate Audit vMax)
#   è¦†ç›–ï¼šBBR/å†…æ ¸/DNS/é˜²ç«å¢™/åè®®æ ˆ/è‡ªåŠ¨åŒ–/ç¼“å­˜/è¿ç»´
# ======================================================================

# --- é¢œè‰²å®šä¹‰ ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# --- ä¾èµ–æ£€æŸ¥ ---
if ! command -v dig &> /dev/null; then apt update -y && apt install dnsutils -y; fi
if ! command -v lsattr &> /dev/null; then apt install e2fsprogs -y; fi

clear
echo -e "\${CYAN}============================================================\${NC}"
echo -e "           ğŸ“Š VPS å…¨æ ˆç¯å¢ƒæ·±åº¦å®¡è®¡æŠ¥å‘Š (TikTokä¸“ç”¨)"
echo -e "\${CYAN}============================================================\${NC}"

# ===========================
# 1. å†…æ ¸ä¸æ€§èƒ½å±‚ (The Engine)
# ===========================
echo -e "\n\${YELLOW}[1. å†…æ ¸ä¸æ€§èƒ½åŠ¨åŠ›]\${NC}"

# 1.1 BBR æ£€æµ‹
BBR_CHECK=\$(sysctl net.ipv4.tcp_congestion_control | awk '{print \$3}')
if [[ "\$BBR_STATUS" == "bbr" ]] || [[ "\$BBR_CHECK" == *"bbr"* ]]; then
    echo -e "TCP æ‹¥å¡æ§åˆ¶ (BBR)   : \${GREEN}âœ… å·²å¼€å¯ (æ¨æµåŠ¨åŠ›æ ¸å¿ƒ)\${NC}"
else
    echo -e "TCP æ‹¥å¡æ§åˆ¶ (BBR)   : \${RED}âŒ æœªå¼€å¯ (ç›´æ’­ä¼šå¡é¡¿)\${NC}"
fi

# 1.2 IPv6 ç¦ç”¨æ£€æµ‹
IPV6_CHECK=\$(sysctl net.ipv6.conf.all.disable_ipv6 | awk '{print \$3}')
if [[ "\$IPV6_CHECK" == "1" ]]; then
    echo -e "IPv6 ç¦ç”¨çŠ¶æ€        : \${GREEN}âœ… å·²å½»åº•ç¦ç”¨ (é˜²æ³„éœ²/é˜²ç»•è·¯)\${NC}"
else
    echo -e "IPv6 ç¦ç”¨çŠ¶æ€        : \${RED}âŒ æœªç¦ç”¨ (å­˜åœ¨éšæ‚£)\${NC}"
fi

# 1.3 æ–‡ä»¶æ‰“å¼€æ•°é™åˆ¶
ULIMIT_CHECK=\$(ulimit -n)
if [[ "\$ULIMIT_CHECK" -gt 60000 ]]; then
    echo -e "æœ€å¤§è¿æ¥æ•°é™åˆ¶       : \${GREEN}âœ… å·²è§£é” (\$ULIMIT_CHECK) (æ”¯æŒé«˜å¹¶å‘)\${NC}"
else
    echo -e "æœ€å¤§è¿æ¥æ•°é™åˆ¶       : \${RED}âŒ é»˜è®¤å€¼ (\$ULIMIT_CHECK) (å®¹æ˜“æ–­æµ)\${NC}"
fi

# 1.4 ç½‘å¡é˜Ÿåˆ—é•¿åº¦
IFACE=\$(ip route | grep default | awk '{print \$5}' | head -n1)
TXQ=\$(cat /sys/class/net/\$IFACE/tx_queue_len)
if [[ "\$TXQ" -ge 10000 ]]; then
    echo -e "ç½‘å¡å‘é€é˜Ÿåˆ—         : \${GREEN}âœ… å·²æ‰©å®¹ (\$TXQ) (é˜²å¾®è§‚ä¸¢åŒ…)\${NC}"
else
    echo -e "ç½‘å¡å‘é€é˜Ÿåˆ—         : \${RED}âŒ æœªä¼˜åŒ– (\$TXQ) (å»ºè®®è®¾ä¸º10000)\${NC}"
fi

# ===========================
# 2. DNS ä¸ è§£æå±‚ (The Brain)
# ===========================
echo -e "\n\${YELLOW}[2. DNS è§£æä¸å®‰å…¨]\${NC}"

# 2.1 DNS é”å®šçŠ¶æ€
ATTR=\$(lsattr /etc/resolv.conf)
if [[ "\$ATTR" == *"i"* ]]; then
    echo -e "é…ç½®æ–‡ä»¶é˜²ç¯¡æ”¹é”     : \${GREEN}âœ… å·²ç„Šæ­» (+i ç”Ÿæ•ˆ)\${NC}"
else
    echo -e "é…ç½®æ–‡ä»¶é˜²ç¯¡æ”¹é”     : \${RED}âŒ æœªé”å®š (é‡å¯åå¯èƒ½è¢«äº‘å‚å•†ä¿®æ”¹)\${NC}"
fi

# 2.2 DNS å†…å®¹æ£€æŸ¥
CONF=\$(cat /etc/resolv.conf)
if [[ "\$CONF" == *"1.1.1.1"* ]]; then
    echo -e "DNS æœåŠ¡å™¨æŒ‡å‘       : \${GREEN}âœ… å›½é™…æ ‡å‡† (1.1.1.1)\${NC}"
else
    echo -e "DNS æœåŠ¡å™¨æŒ‡å‘       : \${RED}âŒ å¼‚å¸¸ (å«å†…ç½‘IP?)\${NC}"
fi

# 2.3 NSCD ç¼“å­˜æ£€æµ‹
if systemctl is-active --quiet nscd; then
    echo -e "æœ¬åœ° DNS å†…å­˜ç¼“å­˜    : \${GREEN}âœ… NSCD è¿è¡Œä¸­ (0ms è§£æ)\${NC}"
else
    echo -e "æœ¬åœ° DNS å†…å­˜ç¼“å­˜    : \${RED}âŒ æœªè¿è¡Œ (è§£æèµ·æ­¥æ…¢)\${NC}"
fi

# ===========================
# 3. é˜²ç«å¢™ä¸æµæ§ (The Gatekeeper)
# ===========================
echo -e "\n\${YELLOW}[3. é˜²ç«å¢™ä¸æµæ§]\${NC}"

# 3.1 MSS é’³åˆ¶ (é…åˆæ‰‹æœº1400)
MSS_RULE=\$(iptables -t mangle -L OUTPUT -n | grep "TCPMSS set 1360")
if [[ -n "\$MSS_RULE" ]]; then
    echo -e "MSS å¼ºåˆ¶é’³åˆ¶ (1360)  : \${GREEN}âœ… å·²ç”Ÿæ•ˆ (é˜²ç½‘é¡µè½¬åœˆ/é˜²å¡é¡¿)\${NC}"
else
    echo -e "MSS å¼ºåˆ¶é’³åˆ¶ (1360)  : \${RED}âŒ è§„åˆ™ç¼ºå¤± (ä¸¥é‡éšæ‚£)\${NC}"
fi

# 3.2 QUIC é˜»æ–­
QUIC_RULE=\$(iptables -L OUTPUT -n | grep "udp dpt:443")
if [[ -n "\$QUIC_RULE" ]]; then
    echo -e "QUIC (UDP) ç‰©ç†é˜»æ–­  : \${GREEN}âœ… å·²å°æ€ (é€¼è¿«æµè§ˆå™¨èµ°TCPé«˜é€Ÿ)\${NC}"
else
    echo -e "QUIC (UDP) ç‰©ç†é˜»æ–­  : \${RED}âŒ æœªé˜»æ–­ (YouTubeå¯èƒ½æ…¢)\${NC}"
fi

# ===========================
# 4. è‡ªåŠ¨åŒ–ä¸è¿ç»´ (The Autopilot)
# ===========================
echo -e "\n\${YELLOW}[4. è‡ªåŠ¨åŒ–ä¸è¿ç»´ä¿éšœ]\${NC}"

# 4.1 æ—¶é—´åŒæ­¥
if systemctl is-active --quiet chronyd || systemctl is-active --quiet chrony; then
    echo -e "æ—¶é—´åŒæ­¥å®ˆæŠ¤è¿›ç¨‹     : \${GREEN}âœ… Chrony è¿è¡Œä¸­ (é˜²åè®®æ–­è¿)\${NC}"
else
    echo -e "æ—¶é—´åŒæ­¥å®ˆæŠ¤è¿›ç¨‹     : \${RED}âŒ æœªè¿è¡Œ\${NC}"
fi

# 4.2 é¢„çƒ­è„šæœ¬
if crontab -l 2>/dev/null | grep -q "warmup_pro.sh"; then
    echo -e "å…¨é“¾è·¯è‡ªåŠ¨é¢„çƒ­       : \${GREEN}âœ… å·²éƒ¨ç½² (æ¯åˆ†é’Ÿä¿æŒè¿æ¥çƒ­åº¦)\${NC}"
else
    echo -e "å…¨é“¾è·¯è‡ªåŠ¨é¢„çƒ­       : \${RED}âŒ æœªéƒ¨ç½²\${NC}"
fi

# 4.3 è¿›ç¨‹ææƒ
if crontab -l 2>/dev/null | grep -q "boost_proxy.sh"; then
    echo -e "è¿›ç¨‹ VIP ææƒ        : \${GREEN}âœ… å·²éƒ¨ç½² (èŠ‚ç‚¹è¿›ç¨‹æŠ¢å CPU)\${NC}"
else
    echo -e "è¿›ç¨‹ VIP ææƒ        : \${RED}âŒ æœªéƒ¨ç½²\${NC}"
fi

# 4.4 æ—¥å¿—æ¸…ç†
if [[ -f /etc/cron.daily/cleanup_logs ]]; then
    echo -e "æ—¥å¿—è‡ªåŠ¨æ¸…ç†         : \${GREEN}âœ… å·²éƒ¨ç½² (é˜²ç¡¬ç›˜çˆ†ç‚¸)\${NC}"
else
    echo -e "æ—¥å¿—è‡ªåŠ¨æ¸…ç†         : \${RED}âŒ æœªéƒ¨ç½²\${NC}"
fi

# ===========================
# 5. æœ€ç»ˆè¿é€šæ€§æµ‹è¯•
# ===========================
echo -e "\n\${YELLOW}[5. æ ¸å¿ƒä¸šåŠ¡è¿é€šæ€§]\${NC}"
# æµ‹è¯• Google è§£æä¸è¿æ¥
Start=\$(date +%s%N)
curl -o /dev/null -s --connect-timeout 2 https://www.google.com
if [ \$? -eq 0 ]; then
    End=\$(date +%s%N)
    Duration=\$(( (End - Start) / 1000000 ))
    echo -e "Google è¿æ¥æµ‹è¯•      : \${GREEN}âœ… é€šç•… (è€—æ—¶: \${Duration}ms)\${NC}"
else
    echo -e "Google è¿æ¥æµ‹è¯•      : \${RED}âŒ å¤±è´¥ (ç½‘ç»œä¸é€š?)\${NC}"
fi

echo -e "\n\${CYAN}============================================================\${NC}"
EOF
)



