#!/usr/bin/env bash
# ============================================================================
# Debian 12/13 ç»ˆæç½‘ç»œä¼˜åŒ–è„šæœ¬ - BBRv3 æé™æ€§èƒ½ç‰ˆ
# ============================================================================
# ç‰ˆæœ¬: 3.0-extreme-final
# ä½œè€…: æ•´åˆè‡ªå¤šä¸ªç¤¾åŒºä¼˜åŒ–æ–¹æ¡ˆ
# è¯´æ˜: æœ¬è„šæœ¬é»˜è®¤é‡‡ç”¨æé™æ€§èƒ½æ¨¡å¼ï¼Œæ‰€æœ‰å‚æ•°å·²è°ƒä¼˜è‡³æœ€æ¿€è¿›é…ç½®
# é€‚ç”¨: Debian 12/13 (x86_64) çº¯å‡€ç³»ç»Ÿ
# ============================================================================

set -euo pipefail
IFS=$'\n\t'

# ============================================================================
# å…¨å±€é…ç½®
# ============================================================================
VERSION="3.0-extreme-2025"
TMP="/tmp/bbr-optimizer-$$"
mkdir -p "$TMP"
trap 'rm -rf "$TMP"' EXIT

# é…ç½®æ–‡ä»¶è·¯å¾„
SYSCTL_CONF="/etc/sysctl.d/99-bbr-extreme.conf"
LIMITS_CONF="/etc/security/limits.d/99-bbr-extreme.conf"

# ç³»ç»Ÿä¿¡æ¯å…¨å±€å˜é‡
declare -A SYS NET NIC

# ============================================================================
# é¢œè‰²è¾“å‡ºå‡½æ•°
# ============================================================================
_log()  { printf "\033[36m[%s]\033[0m %s\n" "$(date +%T)" "$*"; }
_ok()   { printf "\033[32m[âœ“]\033[0m %s\n" "$*"; }
_warn() { printf "\033[33m[!]\033[0m %s\n" "$*" >&2; }
_err()  { printf "\033[31m[âœ—]\033[0m %s\n" "$*" >&2; exit 1; }
_title(){ printf "\n\033[1;36mâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\033[0m\n"; }
_section(){ printf "\n\033[1;35mâ•”â•â• %s â•â•â•—\033[0m\n" "$*"; }

has() { command -v "$1" >/dev/null 2>&1; }
to_int() { local v="${1:-0}"; v="${v//[^0-9]/}"; echo "${v:-0}"; }

# ============================================================================
# ç³»ç»Ÿæ£€æŸ¥
# ============================================================================
check_system() {
    _section "ç³»ç»Ÿç¯å¢ƒæ£€æŸ¥"
    
    # å¿…é¡»rootæƒé™
    [ "$(id -u)" -ne 0 ] && _err "âŒ æ­¤è„šæœ¬éœ€è¦rootæƒé™ï¼Œè¯·ä½¿ç”¨: sudo $0"
    
    # æ£€æŸ¥ç³»ç»Ÿç‰ˆæœ¬
    if [ ! -f /etc/os-release ]; then
        _err "âŒ æ— æ³•è¯†åˆ«ç³»ç»Ÿç‰ˆæœ¬"
    fi
    
    . /etc/os-release
    
    if [[ "$ID" != "debian" && "$ID" != "ubuntu" ]]; then
        _err "âŒ æ­¤è„šæœ¬ä»…æ”¯æŒDebian/Ubuntuç³»ç»Ÿï¼Œå½“å‰: $ID"
    fi
    
    _ok "âœ“ æ“ä½œç³»ç»Ÿ: $PRETTY_NAME"
    
    # æ£€æŸ¥æ¶æ„ (ä»…æ”¯æŒx86_64)
    local arch=$(uname -m)
    if [[ "$arch" != "x86_64" ]]; then
        _err "âŒ æ­¤ç‰ˆæœ¬ä»…æ”¯æŒx86_64æ¶æ„ï¼Œå½“å‰: $arch"
    fi
    
    _ok "âœ“ ç³»ç»Ÿæ¶æ„: x86_64"
}

# ============================================================================
# ä¾èµ–å®‰è£…
# ============================================================================
install_dependencies() {
    _section "å®‰è£…å¿…è¦ä¾èµ–"
    
    local deps=("curl" "wget" "jq" "ethtool" "bc" "gnupg" "lsb-release" "ca-certificates" "cpufrequtils")
    local missing=()
    
    for dep in "${deps[@]}"; do
        if ! has "$dep"; then
            missing+=("$dep")
        fi
    done
    
    if [ ${#missing[@]} -gt 0 ]; then
        _log "ğŸ“¦ å®‰è£…ç¼ºå¤±ä¾èµ–: ${missing[*]}"
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -qq || _err "âŒ apt-get update å¤±è´¥"
        apt-get install -y -qq "${missing[@]}" 2>&1 | grep -v "æ­£åœ¨" || true
        _ok "âœ“ ä¾èµ–å®‰è£…å®Œæˆ"
    else
        _ok "âœ“ æ‰€æœ‰ä¾èµ–å·²å°±ç»ª"
    fi
}

# ============================================================================
# ç³»ç»Ÿä¿¡æ¯æ£€æµ‹
# ============================================================================
detect_system_info() {
    _section "ç³»ç»Ÿç¡¬ä»¶ä¿¡æ¯æ£€æµ‹"
    
    # åŸºç¡€ä¿¡æ¯
    SYS[kernel]=$(uname -r)
    SYS[cpu]=$(nproc)
    SYS[mem_kb]=$(awk '/MemTotal/ {print $2}' /proc/meminfo)
    SYS[mem_bytes]=$((SYS[mem_kb] * 1024))
    SYS[mem_gb]=$(awk -v b="${SYS[mem_bytes]}" 'BEGIN{printf "%.1f", b/1024/1024/1024}')
    
    # è™šæ‹ŸåŒ–ç±»å‹
    if has systemd-detect-virt; then
        SYS[virt]=$(systemd-detect-virt 2>/dev/null || echo "unknown")
    else
        SYS[virt]="unknown"
    fi
    
    # æ£€æµ‹ä¸»ç½‘å¡
    SYS[iface]=$(ip -o route get 1.1.1.1 2>/dev/null | awk '{for(i=1;i<=NF;i++) if($i=="dev") print $(i+1)}' | head -1)
    if [ -z "${SYS[iface]}" ]; then
        SYS[iface]=$(ip -o link show | awk -F': ' '$2!~/^(lo|virbr|docker|veth)/ {print $2; exit}')
    fi
    [ -z "${SYS[iface]}" ] && _err "âŒ æ— æ³•æ£€æµ‹ä¸»ç½‘ç»œæ¥å£"
    
    local iface="${SYS[iface]}"
    
    # ç½‘å¡è¯¦ç»†ä¿¡æ¯
    NIC[driver]=$(ethtool -i "$iface" 2>/dev/null | awk '/^driver:/ {print $2}' || echo "unknown")
    NIC[speed]=$(ethtool "$iface" 2>/dev/null | awk '/Speed:/ {print $2}' | tr -cd '0-9' || echo "0")
    NIC[queues]=$(ethtool -l "$iface" 2>/dev/null | awk '/Combined:/ {print $2; exit}' || echo "1")
    NIC[rx_max]=$(ethtool -g "$iface" 2>/dev/null | awk '/^RX:/{getline; print $1; exit}' || echo "0")
    NIC[tx_max]=$(ethtool -g "$iface" 2>/dev/null | awk '/^TX:/{getline; print $1; exit}' || echo "0")
    
    _ok "âœ“ å†…æ ¸ç‰ˆæœ¬: ${SYS[kernel]}"
    _ok "âœ“ CPUæ ¸å¿ƒæ•°: ${SYS[cpu]} æ ¸"
    _ok "âœ“ ç³»ç»Ÿå†…å­˜: ${SYS[mem_gb]} GB"
    _ok "âœ“ è™šæ‹ŸåŒ–ç±»å‹: ${SYS[virt]}"
    _ok "âœ“ ä¸»ç½‘å¡: $iface"
    _ok "âœ“ ç½‘å¡é©±åŠ¨: ${NIC[driver]}"
    [ "${NIC[speed]}" != "0" ] && _ok "âœ“ ç½‘å¡é€Ÿç‡: ${NIC[speed]} Mbps"
}

# ============================================================================
# RTT (å¾€è¿”å»¶è¿Ÿ) æ™ºèƒ½æ£€æµ‹
# ============================================================================
detect_rtt() {
    _section "ç½‘ç»œå»¶è¿Ÿ(RTT)æ™ºèƒ½æ£€æµ‹"
    
    # ä½¿ç”¨åŠ æƒå¹³å‡æ³•æµ‹è¯•å¤šä¸ªå…¬å…±DNSï¼Œæ›´å‡†ç¡®
    declare -A targets=(
        ["1.1.1.1"]=5      # Cloudflare (æƒé‡æœ€é«˜)
        ["8.8.8.8"]=4      # Google
        ["223.5.5.5"]=3    # é˜¿é‡ŒDNS
        ["114.114.114.114"]=2  # å›½å†…DNS
    )
    
    local total_weighted=0 total_weight=0 success=0
    
    for target in "${!targets[@]}"; do
        local weight=${targets[$target]}
        local tmpfile="${TMP}/ping_${target//./}"
        
        if ping -c 6 -W 2 -i 0.2 "$target" > "$tmpfile" 2>&1; then
            # æå–æ‰€æœ‰å»¶è¿Ÿå€¼
            mapfile -t rtts < <(grep -oP 'time=\K[0-9.]+' "$tmpfile")
            
            if [ ${#rtts[@]} -ge 4 ]; then
                # æ’åºå¹¶å–ä¸­ä½æ•°(æ›´ç¨³å®š)
                IFS=$'\n' sorted=($(printf '%s\n' "${rtts[@]}" | sort -n))
                local median="${sorted[$(( ${#sorted[@]} / 2 ))]}"
                
                # éªŒè¯åˆç†æ€§ (1-1000ms)
                if awk -v m="$median" 'BEGIN{exit !(m>=1 && m<=1000)}'; then
                    total_weighted=$(awk -v tw="$total_weighted" -v m="$median" -v w="$weight" \
                        'BEGIN{printf "%.2f", tw + m*w}')
                    total_weight=$((total_weight + weight))
                    success=$((success + 1))
                    _log "  â””â”€ $target: ${median}ms (æƒé‡=$weight)"
                fi
            fi
            rm -f "$tmpfile"
        fi
    done
    
    if [ "$success" -ge 2 ]; then
        # åŠ æƒå¹³å‡RTT
        NET[rtt]=$(awk -v tw="$total_weighted" -v w="$total_weight" \
            'BEGIN{printf "%.0f", tw/w}')
        _ok "âœ“ æ™ºèƒ½RTTæ£€æµ‹: ${NET[rtt]} ms (åŸºäº${success}ä¸ªæµ‹è¯•ç‚¹)"
    else
        # é»˜è®¤ä¿å®ˆå€¼
        NET[rtt]=30
        _warn "âš  RTTæ£€æµ‹å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤: ${NET[rtt]} ms"
    fi
}

# ============================================================================
# å¸¦å®½æ™ºèƒ½æ£€æµ‹
# ============================================================================
detect_bandwidth() {
    _section "å‡ºå£å¸¦å®½æ™ºèƒ½æ£€æµ‹"
    
    local iface="${SYS[iface]}"
    local bw=0
    
    # æ–¹æ³•1: ä»ç½‘å¡é€Ÿç‡è·å–
    if [ "${NIC[speed]}" != "0" ] && [ "${NIC[speed]}" -gt 0 ]; then
        bw="${NIC[speed]}"
        _log "  â””â”€ ç½‘å¡æ ‡ç§°é€Ÿç‡: ${bw} Mbps"
    fi
    
    # æ–¹æ³•2: åŸºäºCPUå’Œå†…å­˜ä¼°ç®— (äº‘æœåŠ¡å™¨é€šç”¨æ–¹æ³•)
    if [ "$bw" -eq 0 ] || [ "$bw" -gt 10000 ]; then
        local cpu_est=$(( SYS[cpu] * 600 ))  # æé™æ¨¡å¼: æ¯æ ¸å¿ƒ600Mbpsä¼°ç®—
        local mem_est=$(awk -v m="${SYS[mem_gb]}" 'BEGIN{printf "%.0f", m * 500}')
        
        # å–è¾ƒå°å€¼ä½œä¸ºä¼°ç®—
        bw=$(( cpu_est < mem_est ? cpu_est : mem_est ))
        
        # å¯¹äºäº‘æœåŠ¡å™¨ï¼Œåº”ç”¨80%ä¿å®ˆç³»æ•°
        if [[ "${SYS[virt]}" =~ (kvm|xen|vmware) ]]; then
            bw=$(( bw * 80 / 100 ))
        fi
        
        _log "  â””â”€ æ™ºèƒ½ä¼°ç®—å¸¦å®½: ${bw} Mbps (åŸºäº${SYS[cpu]}æ ¸CPU, ${SYS[mem_gb]}GBå†…å­˜)"
    fi
    
    # æœ€å°å€¼ä¿æŠ¤
    [ "$bw" -lt 100 ] && bw=100
    
    # å¯¹äºè¶…é«˜é€Ÿç½‘ç»œï¼Œé™åˆ¶æœ€å¤§ä¼°ç®—å€¼
    [ "$bw" -gt 10000 ] && bw=10000
    
    NET[bw]=$bw
    _ok "âœ“ å‡ºå£å¸¦å®½è®¾å®š: ${NET[bw]} Mbps"
}

# ============================================================================
# BDPè®¡ç®—ä¸æé™ç¼“å†²åŒºé…ç½® (æ ¸å¿ƒä¼˜åŒ–)
# ============================================================================
calculate_extreme_buffers() {
    _section "BDPè®¡ç®—ä¸æé™ç¼“å†²åŒºé…ç½®"
    
    local bw=${NET[bw]}
    local rtt=${NET[rtt]}
    
    # è®¡ç®—BDP (Bandwidth-Delay Product)
    # å…¬å¼: BDP = å¸¦å®½(Mbps) Ã— RTT(ms) / 8
    # è¿™é‡Œä½¿ç”¨æ›´ç²¾ç¡®çš„è®¡ç®—: BDP = (bw * 1000000 / 8) * (rtt / 1000)
    local bdp=$(awk -v bw="$bw" -v rtt="$rtt" 'BEGIN{printf "%.0f", bw * 125 * rtt}')
    
    NET[bdp]=$bdp
    NET[bdp_mb]=$(awk -v b="$bdp" 'BEGIN{printf "%.2f", b/1024/1024}')
    
    _log "  â””â”€ BDP = ${NET[bdp]} bytes (${NET[bdp_mb]} MB)"
    
    # å†…å­˜å®‰å…¨è¾¹ç•Œ
    local mem_15pct=$(( SYS[mem_bytes] * 15 / 100 ))  # 15%å†…å­˜ä¸Šé™
    local mem_20pct=$(( SYS[mem_bytes] * 20 / 100 ))  # 20%å†…å­˜ä¸Šé™(æé™)
    
    # ========================================
    # æé™æ¨¡å¼ TCP ç¼“å†²åŒºé…ç½®
    # ========================================
    # ä½¿ç”¨ 5å€BDP ä½œä¸ºæœ€å¤§ç¼“å†²(æé™æ¨¡å¼ï¼Œä¸€èˆ¬ä¸º3-4å€)
    local tcp_max=$(( bdp * 5 ))
    
    # å®‰å…¨ä¸Šé™: ä¸è¶…è¿‡å†…å­˜çš„20%
    [ "$tcp_max" -gt "$mem_20pct" ] && tcp_max="$mem_20pct"
    
    # æœ€å°ä¿éšœ: è‡³å°‘16MB
    [ "$tcp_max" -lt 16777216 ] && tcp_max=16777216
    
    NET[tcp_rmem_max]=$tcp_max
    NET[tcp_wmem_max]=$tcp_max
    
    # é»˜è®¤ç¼“å†²: è®¾ç½®ä¸ºè¾ƒå¤§å€¼ä»¥åº”å¯¹çªå‘æµé‡
    NET[tcp_rmem_def]=$(( bdp > 262144 ? bdp : 262144 ))  # è‡³å°‘256KB
    NET[tcp_wmem_def]="${NET[tcp_rmem_def]}"
    
    # æœ€å°ç¼“å†²: ä¿æŒ4KB (ç³»ç»Ÿé»˜è®¤é¡µå¤§å°)
    NET[tcp_rmem_min]=4096
    NET[tcp_wmem_min]=4096
    
    _ok "âœ“ TCPè¯»ç¼“å†²: æœ€å°=4KB, é»˜è®¤=$((NET[tcp_rmem_def]/1024))KB, æœ€å¤§=$((tcp_max/1024/1024))MB"
    _ok "âœ“ TCPå†™ç¼“å†²: æœ€å°=4KB, é»˜è®¤=$((NET[tcp_wmem_def]/1024))KB, æœ€å¤§=$((tcp_max/1024/1024))MB"
    
    # ========================================
    # æé™æ¨¡å¼ UDP ç¼“å†²åŒºé…ç½®
    # ========================================
    local udp_max=$(( bdp * 3 ))  # UDPä½¿ç”¨3å€BDP
    
    # å®‰å…¨ä¸Šé™: ä¸è¶…è¿‡å†…å­˜çš„15%
    [ "$udp_max" -gt "$mem_15pct" ] && udp_max="$mem_15pct"
    
    # æœ€å°ä¿éšœ: è‡³å°‘8MB
    [ "$udp_max" -lt 8388608 ] && udp_max=8388608
    
    NET[udp_rmem_min]=16384   # 16KBæœ€å°
    NET[udp_wmem_min]=16384
    
    # UDPå†…å­˜é¡µé…ç½® (ä»¥4KBé¡µä¸ºå•ä½)
    local page=4096
    NET[udp_mem_min]=$(( udp_max / page / 4 ))     # å‹åŠ›ä¸‹é™: 25%
    NET[udp_mem_pressure]=$(( udp_max / page / 2 )) # å‹åŠ›é˜ˆå€¼: 50%
    NET[udp_mem_max]=$(( udp_max / page ))          # æœ€å¤§å€¼: 100%
    
    _ok "âœ“ UDPç¼“å†²: æœ€å¤§=$((udp_max/1024/1024))MB, é¡µæ•°=${NET[udp_mem_min]}/${NET[udp_mem_pressure]}/${NET[udp_mem_max]}"
    
    # ========================================
    # æé™æ¨¡å¼ ç½‘ç»œé˜Ÿåˆ—é…ç½®
    # ========================================
    # backlog: åŸºäºå¸¦å®½çš„è¿æ¥é˜Ÿåˆ—æ·±åº¦
    local backlog=$(( bw * 120 ))  # æé™: å¸¦å®½ Ã— 120
    [ "$backlog" -lt 32768 ] && backlog=32768
    [ "$backlog" -gt 2000000 ] && backlog=2000000
    NET[backlog]=$backlog
    
    # budget: æ¯æ¬¡NAPI pollå¤„ç†çš„æ•°æ®åŒ…æ•°
    NET[budget]=$(( backlog / 8 ))
    [ "${NET[budget]}" -gt 65536 ] && NET[budget]=65536
    
    _ok "âœ“ ç½‘ç»œé˜Ÿåˆ—: backlog=${NET[backlog]}, budget=${NET[budget]}"
    
    # ========================================
    # æé™æ¨¡å¼ è¿æ¥è·Ÿè¸ªè¡¨ (Conntrack)
    # ========================================
    # åŸºäºå†…å­˜å¤§å°è®¡ç®—ï¼Œæé™æ¨¡å¼ä½¿ç”¨æ›´æ¿€è¿›çš„é…ç½®
    local ct=$(( SYS[mem_bytes] / 16384 ))  # æé™: æ¯16KBå†…å­˜ä¸€ä¸ªè¿æ¥
    
    [ "$ct" -lt 131072 ] && ct=131072      # æœ€å°13ä¸‡
    [ "$ct" -gt 1048576 ] && ct=1048576    # æœ€å¤§104ä¸‡
    
    NET[conntrack]=$ct
    
    _ok "âœ“ è¿æ¥è·Ÿè¸ª: ${NET[conntrack]} æ¡"
}

# ============================================================================
# ç”Ÿæˆæé™æ¨¡å¼ Sysctl é…ç½®æ–‡ä»¶
# ============================================================================
generate_sysctl_config() {
    _section "ç”ŸæˆSysctlæé™ä¼˜åŒ–é…ç½®"
    
    # æé™æ¨¡å¼: è¶…å¤§è¿æ¥é˜Ÿåˆ—
    local somaxconn=524288   # 52ä¸‡è¿æ¥é˜Ÿåˆ— (æé™å€¼)
    local syn_backlog=524288 # 52ä¸‡SYNé˜Ÿåˆ—
    
    cat > "$SYSCTL_CONF" <<EOF
# ============================================================================
# Debian ç»ˆæç½‘ç»œä¼˜åŒ–é…ç½® - BBRv3 æé™æ€§èƒ½æ¨¡å¼
# ============================================================================
# ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
# ç³»ç»Ÿé…ç½®: ${SYS[cpu]}æ ¸CPU, ${SYS[mem_gb]}GBå†…å­˜, ${NET[bw]}Mbpså¸¦å®½
# BDPå‚æ•°: ${NET[bdp]} bytes (${NET[bdp_mb]} MB)
# ============================================================================

# ----------------------------------------------------------------------------
# BBRv3 æ‹¥å¡æ§åˆ¶ (æ ¸å¿ƒ)
# ----------------------------------------------------------------------------
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr

# ----------------------------------------------------------------------------
# æ ¸å¿ƒç½‘ç»œç¼“å†²åŒº (æé™é…ç½®)
# ----------------------------------------------------------------------------
# é»˜è®¤æ¥æ”¶/å‘é€ç¼“å†²åŒº: 256KBèµ·æ­¥
net.core.rmem_default = 262144
net.core.wmem_default = 262144

# æœ€å¤§æ¥æ”¶/å‘é€ç¼“å†²åŒº: åŸºäº5å€BDPè®¡ç®—
net.core.rmem_max = ${NET[tcp_rmem_max]}
net.core.wmem_max = ${NET[tcp_wmem_max]}

# é€‰é¡¹å†…å­˜: ç”¨äºTCPé€‰é¡¹(å¦‚timestamps)
net.core.optmem_max = 524288

# ----------------------------------------------------------------------------
# TCP ç¼“å†²åŒºè‡ªåŠ¨è°ƒä¼˜ (æé™é…ç½®)
# ----------------------------------------------------------------------------
# æ ¼å¼: æœ€å°å€¼ é»˜è®¤å€¼ æœ€å¤§å€¼
net.ipv4.tcp_rmem = ${NET[tcp_rmem_min]} ${NET[tcp_rmem_def]} ${NET[tcp_rmem_max]}
net.ipv4.tcp_wmem = ${NET[tcp_wmem_min]} ${NET[tcp_wmem_def]} ${NET[tcp_wmem_max]}

# å¯ç”¨TCPç¼“å†²åŒºè‡ªåŠ¨è°ƒä¼˜(å¿…é¡»)
net.ipv4.tcp_moderate_rcvbuf = 1

# TCPå†…å­˜é¡µé…ç½® (è‡ªåŠ¨è°ƒä¼˜è¾¹ç•Œ)
net.ipv4.tcp_mem = $(( NET[tcp_rmem_max] / 4096 / 4 )) $(( NET[tcp_rmem_max] / 4096 / 2 )) $(( NET[tcp_rmem_max] / 4096 ))

# ----------------------------------------------------------------------------
# TCP è¿æ¥é˜Ÿåˆ— (æé™é…ç½®)
# ----------------------------------------------------------------------------
# å·²å®Œæˆè¿æ¥é˜Ÿåˆ—: 52ä¸‡ (æé™å€¼ï¼Œé»˜è®¤4096)
net.core.somaxconn = ${somaxconn}

# SYNé˜Ÿåˆ—: 52ä¸‡ (æé™å€¼ï¼Œé»˜è®¤1024)
net.ipv4.tcp_max_syn_backlog = ${syn_backlog}

# ç½‘ç»œè®¾å¤‡æ¥æ”¶é˜Ÿåˆ—: åŸºäºå¸¦å®½åŠ¨æ€è®¡ç®—
net.core.netdev_max_backlog = ${NET[backlog]}

# NAPIé¢„ç®—: æ¯æ¬¡è½®è¯¢å¤„ç†çš„åŒ…æ•°
net.core.netdev_budget = ${NET[budget]}
net.core.netdev_budget_usecs = 8000

# ----------------------------------------------------------------------------
# TCP æ€§èƒ½ä¼˜åŒ– (æé™é…ç½®)
# ----------------------------------------------------------------------------
# TCP Fast Open: å¯ç”¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ (å€¼ä¸º3)
net.ipv4.tcp_fastopen = 3

# TIME_WAITé‡ç”¨: å¯ç”¨
net.ipv4.tcp_tw_reuse = 1

# FINè¶…æ—¶: ç¼©çŸ­è‡³10ç§’ (é»˜è®¤60ç§’)
net.ipv4.tcp_fin_timeout = 10

# å…³é—­æ…¢å¯åŠ¨é‡å¯: æå‡é•¿è¿æ¥æ€§èƒ½
net.ipv4.tcp_slow_start_after_idle = 0

# MTUæ¢æµ‹: å¯ç”¨(é¿å…é»‘æ´)
net.ipv4.tcp_mtu_probing = 1

# ä¿æ´»æ—¶é—´: å‡å°‘è‡³10åˆ†é’Ÿ (é»˜è®¤2å°æ—¶)
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl = 15

# TCPæ—¶é—´æˆ³: å¯ç”¨(PAWSä¿æŠ¤)
net.ipv4.tcp_timestamps = 1

# TCPçª—å£ç¼©æ”¾: å¯ç”¨(å¿…é¡»ï¼Œæ”¯æŒå¤§çª—å£)
net.ipv4.tcp_window_scaling = 1

# TCP SACK: å¯ç”¨é€‰æ‹©æ€§ç¡®è®¤
net.ipv4.tcp_sack = 1

# ç¦ç”¨TCPè½¬å‘æ—¶çš„ECN: é¿å…å…¼å®¹æ€§é—®é¢˜
net.ipv4.tcp_ecn = 0

# ----------------------------------------------------------------------------
# UDP ç¼“å†²åŒº (æé™é…ç½®)
# ----------------------------------------------------------------------------
net.ipv4.udp_rmem_min = ${NET[udp_rmem_min]}
net.ipv4.udp_wmem_min = ${NET[udp_wmem_min]}

# UDPå†…å­˜é¡µé…ç½® (min/pressure/max)
net.ipv4.udp_mem = ${NET[udp_mem_min]} ${NET[udp_mem_pressure]} ${NET[udp_mem_max]}

# ----------------------------------------------------------------------------
# RPS/RFS å¤šé˜Ÿåˆ—è´Ÿè½½å‡è¡¡
# ----------------------------------------------------------------------------
# RFSæµè¡¨æ¡ç›®: 6.5ä¸‡ (é…åˆRPSä½¿ç”¨)
net.core.rps_sock_flow_entries = 65536

# ----------------------------------------------------------------------------
# æœ¬åœ°ç«¯å£èŒƒå›´ (æ‰©å¤§å¯ç”¨ç«¯å£)
# ----------------------------------------------------------------------------
net.ipv4.ip_local_port_range = 1024 65535

# ----------------------------------------------------------------------------
# IP è½¬å‘ (ä»£ç†æœåŠ¡å™¨å¿…å¤‡)
# ----------------------------------------------------------------------------
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1
net.ipv6.conf.default.forwarding = 1

# ----------------------------------------------------------------------------
# Netfilter è¿æ¥è·Ÿè¸ª (æé™é…ç½®)
# ----------------------------------------------------------------------------
# æœ€å¤§è¿æ¥è·Ÿè¸ªæ•°: åŸºäºå†…å­˜åŠ¨æ€è®¡ç®—
net.netfilter.nf_conntrack_max = ${NET[conntrack]}

# å·²å»ºç«‹è¿æ¥è¶…æ—¶: 1å°æ—¶
net.netfilter.nf_conntrack_tcp_timeout_established = 3600

# UDPè¿æ¥è¶…æ—¶: 120ç§’
net.netfilter.nf_conntrack_udp_timeout = 120

# å®½æ¾æ¨¡å¼: æå‡NATæ€§èƒ½
net.netfilter.nf_conntrack_tcp_be_liberal = 1
net.netfilter.nf_conntrack_tcp_loose = 1

# ----------------------------------------------------------------------------
# è™šæ‹Ÿå†…å­˜ä¼˜åŒ–
# ----------------------------------------------------------------------------
# é™ä½swapä½¿ç”¨: ä¼˜å…ˆä½¿ç”¨ç‰©ç†å†…å­˜
vm.swappiness = 1

# ç¼“å­˜å‹åŠ›: é™ä½ä»¥ä¿ç•™æ›´å¤šç¼“å­˜
vm.vfs_cache_pressure = 50

# æœ€å°ç©ºé—²å†…å­˜: æé«˜ä»¥é¿å…å†…å­˜ç¢ç‰‡
vm.min_free_kbytes = 65536

# è„é¡µæ¯”ä¾‹: å»¶è¿Ÿç£ç›˜å†™å…¥ä»¥æå‡æ€§èƒ½
vm.dirty_ratio = 20
vm.dirty_background_ratio = 5

# ----------------------------------------------------------------------------
# æ–‡ä»¶ç³»ç»Ÿé™åˆ¶ (æé™é…ç½®)
# ----------------------------------------------------------------------------
# ç³»ç»Ÿçº§æ–‡ä»¶å¥æŸ„ä¸Šé™: 200ä¸‡
fs.file-max = 2097152

# å•è¿›ç¨‹æ–‡ä»¶å¥æŸ„ä¸Šé™: 100ä¸‡
fs.nr_open = 1048576

# Inotifyç›‘æ§é™åˆ¶
fs.inotify.max_user_instances = 8192
fs.inotify.max_user_watches = 524288

# ----------------------------------------------------------------------------
# å…¶ä»–ç½‘ç»œä¼˜åŒ–
# ----------------------------------------------------------------------------
# ç¦ç”¨ICMPé‡å®šå‘(å®‰å…¨)
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0

# ç¦ç”¨æºè·¯ç”±(å®‰å…¨)
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0

# SYN Cookies: å¯ç”¨(é˜²SYN flood)
net.ipv4.tcp_syncookies = 1

# å­¤å„¿socketæœ€å¤§æ•°é‡
net.ipv4.tcp_max_orphans = 262144

# TCPå†…å­˜ä¸è¶³æ—¶çš„æœ€å¤§å­¤å„¿æ•°
net.ipv4.tcp_max_tw_buckets = 262144

# ============================================================================
# é…ç½®ç»“æŸ
# ============================================================================
EOF
    
    _ok "âœ“ é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ: $SYSCTL_CONF"
}

# ============================================================================
# ç”Ÿæˆç”¨æˆ·é™åˆ¶é…ç½®
# ============================================================================
generate_limits_config() {
    _section "ç”Ÿæˆç”¨æˆ·é™åˆ¶é…ç½®"
    
    cat > "$LIMITS_CONF" <<EOF
# BBRæé™ä¼˜åŒ– - ç”¨æˆ·èµ„æºé™åˆ¶
# æ–‡ä»¶å¥æŸ„æ•°ä¸Šé™è®¾ç½®ä¸º100ä¸‡

*  soft  nofile  1048576
*  hard  nofile  1048576
root  soft  nofile  1048576
root  hard  nofile  1048576
EOF
    
    _ok "âœ“ ç”¨æˆ·é™åˆ¶é…ç½®å·²ç”Ÿæˆ: $LIMITS_CONF"
}

# ============================================================================
# åº”ç”¨ Sysctl é…ç½®
# ============================================================================
apply_sysctl_config() {
    _section "åº”ç”¨Sysctlé…ç½®åˆ°è¿è¡Œç³»ç»Ÿ"
    
    # å…ˆå°è¯•åŠ è½½å¿…è¦çš„å†…æ ¸æ¨¡å—
    modprobe tcp_bbr 2>/dev/null || true
    modprobe sch_fq 2>/dev/null || true
    modprobe nf_conntrack 2>/dev/null || true
    
    # åº”ç”¨é…ç½®
    if sysctl -p "$SYSCTL_CONF" >/dev/null 2>&1; then
        _ok "âœ“ Sysctlé…ç½®å·²æˆåŠŸåº”ç”¨"
    else
        _warn "âš  Sysctlé…ç½®åº”ç”¨æ—¶æœ‰éƒ¨åˆ†è­¦å‘Š(å¯èƒ½éœ€è¦é‡å¯æˆ–å®‰è£…BBRå†…æ ¸)"
        sysctl -p "$SYSCTL_CONF" 2>&1 | grep -i "error\|cannot" || true
    fi
    
    # è®¾ç½®conntrackå“ˆå¸Œè¡¨å¤§å°
    local hash=$(( NET[conntrack] / 4 ))
    if [ -w /sys/module/nf_conntrack/parameters/hashsize ]; then
        echo "$hash" > /sys/module/nf_conntrack/parameters/hashsize 2>/dev/null || true
        _ok "âœ“ Conntrackå“ˆå¸Œè¡¨å¤§å°: $hash"
    fi
}

# ============================================================================
# ç½‘å¡ç¡¬ä»¶ä¼˜åŒ– (æé™é…ç½®)
# ============================================================================
optimize_nic_hardware() {
    _section "ç½‘å¡ç¡¬ä»¶æé™ä¼˜åŒ–"
    
    local iface="${SYS[iface]}"
    
    # ========================================
    # Ring Buffer ä¼˜åŒ–
    # ========================================
    # å°†æ¥æ”¶å’Œå‘é€é˜Ÿåˆ—è®¾ç½®ä¸ºæœ€å¤§å€¼çš„80% (Netflixå»ºè®®å€¼)
    if [ "${NIC[rx_max]}" -gt 512 ] && [ "${NIC[tx_max]}" -gt 512 ]; then
        local rx=$(( NIC[rx_max] * 80 / 100 ))
        local tx=$(( NIC[tx_max] * 80 / 100 ))
        
        [ "$rx" -lt 512 ] && rx=512
        [ "$tx" -lt 512 ] && tx=512
        
        if ethtool -G "$iface" rx "$rx" tx "$tx" 2>/dev/null; then
            _ok "âœ“ Ring Buffer: RX=$rx, TX=$tx"
        else
            _log "  â””â”€ Ring Bufferè°ƒæ•´å¤±è´¥(å¯èƒ½ä¸æ”¯æŒ)"
        fi
    fi
    
    # ========================================
    # Offload ç‰¹æ€§ä¼˜åŒ–
    # ========================================
    # å¯ç”¨ç¡¬ä»¶å¸è½½ä»¥é™ä½CPUè´Ÿè½½
    ethtool -K "$iface" tso on 2>/dev/null || true  # TCP Segmentation Offload
    ethtool -K "$iface" gso on 2>/dev/null || true  # Generic Segmentation Offload
    ethtool -K "$iface" sg on 2>/dev/null || true   # Scatter-Gather
    ethtool -K "$iface" gro on 2>/dev/null || true  # Generic Receive Offload
    
    _ok "âœ“ ç¡¬ä»¶å¸è½½: TSO, GSO, SG, GRO å·²å¯ç”¨"
    
    # UDP GRO ä¼˜åŒ– (ç°ä»£å†…æ ¸æ”¯æŒ)
    ethtool -K "$iface" rx-udp-gro-forwarding on 2>/dev/null || true
    ethtool -K "$iface" rx-gro-list on 2>/dev/null || true
    
    # ========================================
    # ä¸­æ–­åˆå¹¶ (Coalesce) - ä½å»¶è¿Ÿé…ç½®
    # ========================================
    # æé™æ¨¡å¼: è¿½æ±‚æœ€ä½å»¶è¿Ÿ
    # rx-usecs=100: 100å¾®ç§’æˆ–æ”¶åˆ°64ä¸ªåŒ…åè§¦å‘ä¸­æ–­
    if ethtool -C "$iface" rx-usecs 100 rx-frames 64 adaptive-rx off 2>/dev/null; then
        _ok "âœ“ ä¸­æ–­åˆå¹¶: rx-usecs=100 (ä½å»¶è¿Ÿæ¨¡å¼)"
    else
        _log "  â””â”€ ä¸­æ–­åˆå¹¶è°ƒæ•´å¤±è´¥(å¯èƒ½ä¸æ”¯æŒ)"
    fi
    
    # ========================================
    # å¤šé˜Ÿåˆ—ä¼˜åŒ–
    # ========================================
    # å°†é˜Ÿåˆ—æ•°è®¾ç½®ä¸ºCPUæ ¸å¿ƒæ•° (æœ€å¤§32)
    local desired_queues=${SYS[cpu]}
    [ "$desired_queues" -gt 32 ] && desired_queues=32
    
    # ä¸è¶…è¿‡ç½‘å¡æ”¯æŒçš„æœ€å¤§é˜Ÿåˆ—æ•°
    if [ "${NIC[queues]}" -gt 0 ] && [ "$desired_queues" -gt "${NIC[queues]}" ]; then
        desired_queues=${NIC[queues]}
    fi
    
    if ethtool -L "$iface" combined "$desired_queues" 2>/dev/null; then
        _ok "âœ“ å¤šé˜Ÿåˆ—: $desired_queues ä¸ªé˜Ÿåˆ—"
    fi
    
    # ========================================
    # è™šæ‹ŸåŒ–ç¯å¢ƒç‰¹æ®Šä¼˜åŒ–
    # ========================================
    if [[ "${SYS[virt]}" =~ (kvm|xen) ]] || [[ "${NIC[driver],,}" == *"virtio"* ]]; then
        # Virtioç½‘å¡ç‰¹æ®Šä¼˜åŒ–
        ethtool -K "$iface" tx-nocache-copy off 2>/dev/null || true
        ethtool -K "$iface" tx-checksum-ipv4 on 2>/dev/null || true
        _ok "âœ“ Virtioä¼˜åŒ–å·²åº”ç”¨"
    fi
}

# ============================================================================
# CPUæ©ç ç”Ÿæˆ (æ”¯æŒæœ€å¤š64æ ¸)
# ============================================================================
generate_cpu_mask() {
    local cpu_count=$(to_int "$1")
    [ "$cpu_count" -le 0 ] && echo "1" && return
    [ "$cpu_count" -ge 64 ] && echo "ffffffffffffffff" && return
    
    # ç”Ÿæˆ (2^n - 1) çš„åå…­è¿›åˆ¶è¡¨ç¤º
    if [ "$cpu_count" -le 60 ]; then
        printf '%x' $(( (1 << cpu_count) - 1 ))
    else
        echo "ffffffffffffffff"
    fi
}

# ============================================================================
# RPS/RFS/XPS å¤šé˜Ÿåˆ—è´Ÿè½½å‡è¡¡ä¼˜åŒ–
# ============================================================================
optimize_multiqueue() {
    _section "å¤šé˜Ÿåˆ—è´Ÿè½½å‡è¡¡ä¼˜åŒ– (RPS/RFS/XPS)"
    
    local iface="${SYS[iface]}"
    local cpu_mask=$(generate_cpu_mask "${SYS[cpu]}")
    local queue_dir="/sys/class/net/$iface/queues"
    
    if [ ! -d "$queue_dir" ]; then
        _warn "âš  æœªæ‰¾åˆ°é˜Ÿåˆ—ç›®å½•ï¼Œè·³è¿‡å¤šé˜Ÿåˆ—ä¼˜åŒ–"
        return
    fi
    
    # ========================================
    # RPS (Receive Packet Steering) é…ç½®
    # ========================================
    # å°†æ¥æ”¶é˜Ÿåˆ—åˆ†æ•£åˆ°æ‰€æœ‰CPUæ ¸å¿ƒ
    local rps_count=0
    for rxq in "$queue_dir"/rx-*; do
        [ -e "$rxq/rps_cpus" ] || continue
        
        echo "$cpu_mask" > "$rxq/rps_cpus" 2>/dev/null || true
        echo 4096 > "$rxq/rps_flow_cnt" 2>/dev/null || true
        
        rps_count=$((rps_count + 1))
    done
    
    [ "$rps_count" -gt 0 ] && _ok "âœ“ RPS: $rps_count ä¸ªRXé˜Ÿåˆ—å·²ç»‘å®šåˆ°æ‰€æœ‰CPU"
    
    # ========================================
    # XPS (Transmit Packet Steering) é…ç½®
    # ========================================
    # å°†æ¯ä¸ªå‘é€é˜Ÿåˆ—ç»‘å®šåˆ°ç‰¹å®šCPU (è½®è¯¢åˆ†é…)
    local xps_count=0
    local tx_idx=0
    
    for txq in "$queue_dir"/tx-*; do
        [ -e "$txq/xps_cpus" ] || continue
        
        # è®¡ç®—åº”ç»‘å®šçš„CPUç¼–å·
        local cpu_id=$(( tx_idx % SYS[cpu] ))
        
        # ç”Ÿæˆå•ä¸ªCPUçš„æ©ç 
        local single_mask=$(printf '%x' $((1 << cpu_id)))
        
        echo "$single_mask" > "$txq/xps_cpus" 2>/dev/null || true
        
        xps_count=$((xps_count + 1))
        tx_idx=$((tx_idx + 1))
    done
    
    [ "$xps_count" -gt 0 ] && _ok "âœ“ XPS: $xps_count ä¸ªTXé˜Ÿåˆ—å·²ä¼˜åŒ–"
}

# ============================================================================
# CPUæ€§èƒ½æ¨¡å¼ä¼˜åŒ–
# ============================================================================
optimize_cpu_performance() {
    _section "CPUæ€§èƒ½æ¨¡å¼ä¼˜åŒ–"
    
    # ========================================
    # è®¾ç½®CPUè°ƒé€Ÿå™¨ä¸ºæ€§èƒ½æ¨¡å¼
    # ========================================
    if has cpufreq-set; then
        local cpu_count=${SYS[cpu]}
        for ((i=0; i<cpu_count; i++)); do
            cpufreq-set -c "$i" -g performance 2>/dev/null || true
        done
        _ok "âœ“ CPUè°ƒé€Ÿå™¨: performance (æ‰€æœ‰${cpu_count}ä¸ªæ ¸å¿ƒ)"
    elif has cpupower; then
        if cpupower frequency-set -g performance >/dev/null 2>&1; then
            _ok "âœ“ CPUè°ƒé€Ÿå™¨: performance"
        fi
    else
        _warn "âš  æœªæ‰¾åˆ°cpufreqå·¥å…·ï¼Œè·³è¿‡CPUè°ƒé€Ÿå™¨è®¾ç½®"
    fi
    
    # ========================================
    # THP (é€æ˜å¤§é¡µ) ä¼˜åŒ–
    # ========================================
    if [ -f /sys/kernel/mm/transparent_hugepage/enabled ]; then
        # madviseæ¨¡å¼: ä»…å¯¹æ˜¾å¼è¯·æ±‚çš„å†…å­˜åŒºåŸŸå¯ç”¨å¤§é¡µ
        echo madvise > /sys/kernel/mm/transparent_hugepage/enabled 2>/dev/null || true
        echo defer > /sys/kernel/mm/transparent_hugepage/defrag 2>/dev/null || true
        _ok "âœ“ THP: madviseæ¨¡å¼ (æŒ‰éœ€å¯ç”¨)"
    fi
    
    # ========================================
    # ç¦ç”¨ä¸å¿…è¦çš„CPUç‰¹æ€§ä»¥é™ä½å»¶è¿Ÿ
    # ========================================
    # ç¦ç”¨NUMAå¹³è¡¡ (å¦‚æœæ˜¯å•NUMAèŠ‚ç‚¹ç³»ç»Ÿ)
    if [ -f /proc/sys/kernel/numa_balancing ]; then
        echo 0 > /proc/sys/kernel/numa_balancing 2>/dev/null || true
        _log "  â””â”€ NUMAè‡ªåŠ¨å¹³è¡¡å·²ç¦ç”¨"
    fi
}

# ============================================================================
# BBRv3å†…æ ¸å®‰è£… - ä»GitHubè·å–
# ============================================================================
install_bbrv3_kernel() {
    _title
    echo -e "\033[1;36mğŸš€ BBRv3 å†…æ ¸å®‰è£…\033[0m"
    _title
    
    echo -e "\nğŸ“¡ æ­£åœ¨ä» GitHub è·å–æœ€æ–°å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯..."
    
    local api_url="https://api.github.com/repos/byJoey/Actions-bbr-v3/releases"
    
    # è·å–releasesæ•°æ®
    if ! RELEASE_DATA=$(curl -sL "$api_url" 2>&1); then
        _err "âŒ æ— æ³•è¿æ¥åˆ°GitHub APIï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"
    fi
    
    # è¿‡æ»¤x86_64æ¶æ„çš„ç‰ˆæœ¬
    local latest_tag=$(echo "$RELEASE_DATA" | jq -r \
        'map(select(.tag_name | test("x86_64"; "i"))) | sort_by(.published_at) | .[-1].tag_name' 2>/dev/null)
    
    if [ -z "$latest_tag" ] || [ "$latest_tag" = "null" ]; then
        _err "âŒ æœªæ‰¾åˆ°é€‚åˆx86_64æ¶æ„çš„BBRv3å†…æ ¸ç‰ˆæœ¬"
    fi
    
    echo -e "\033[32mâœ“ æ£€æµ‹åˆ°æœ€æ–°ç‰ˆæœ¬: $latest_tag\033[0m"
    
    # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
    local installed_version=$(dpkg -l 2>/dev/null | grep "linux-image" | grep "joeyblog" | \
        awk '{print $2}' | sed 's/linux-image-//' | head -n 1)
    
    if [ -n "$installed_version" ]; then
        echo -e "ğŸ“¦ å½“å‰å·²å®‰è£…: \033[33m$installed_version\033[0m"
        
        # æå–æ ¸å¿ƒç‰ˆæœ¬å·è¿›è¡Œæ¯”è¾ƒ
        local core_latest="${latest_tag#x86_64-}"
        
        if [[ "$installed_version" == "$core_latest"* ]]; then
            echo -e "\033[1;32mâœ… æ‚¨å·²å®‰è£…æœ€æ–°ç‰ˆæœ¬\033[0m"
            echo -n -e "\næ˜¯å¦è¦é‡æ–°å®‰è£…ï¼Ÿ(y/N): "
            read -r reinstall
            [[ ! "$reinstall" =~ ^[Yy]$ ]] && return 0
        fi
    else
        echo -e "ğŸ“¦ å½“å‰æœªå®‰è£… joeyblog BBRv3 å†…æ ¸"
    fi
    
    # è·å–ä¸‹è½½é“¾æ¥
    echo -e "\nğŸ“¥ æ­£åœ¨å‡†å¤‡ä¸‹è½½å†…æ ¸åŒ…..."
    
    local asset_urls=$(echo "$RELEASE_DATA" | jq -r \
        --arg tag "$latest_tag" \
        '.[] | select(.tag_name == $tag) | .assets[].browser_download_url' 2>/dev/null)
    
    if [ -z "$asset_urls" ]; then
        _err "âŒ æ— æ³•è·å–ä¸‹è½½é“¾æ¥"
    fi
    
    # æ¸…ç†æ—§çš„ä¸‹è½½æ–‡ä»¶
    rm -f /tmp/linux-*.deb
    
    # ä¸‹è½½æ‰€æœ‰.debåŒ…
    local download_count=0
    for url in $asset_urls; do
        local filename=$(basename "$url")
        echo -e "  â””â”€ ä¸‹è½½: \033[36m$filename\033[0m"
        
        if wget -q --show-progress --timeout=60 "$url" -P /tmp/; then
            download_count=$((download_count + 1))
        else
            _err "âŒ ä¸‹è½½å¤±è´¥: $url"
        fi
    done
    
    _ok "âœ“ å·²ä¸‹è½½ $download_count ä¸ªå†…æ ¸åŒ…"
    
    # å¸è½½æ—§ç‰ˆæœ¬
    if [ -n "$installed_version" ]; then
        echo -e "\nğŸ—‘ï¸  æ­£åœ¨å¸è½½æ—§ç‰ˆæœ¬å†…æ ¸..."
        
        local old_packages=$(dpkg -l 2>/dev/null | grep "joeyblog" | awk '{print $2}' | tr '\n' ' ')
        
        if [ -n "$old_packages" ]; then
            DEBIAN_FRONTEND=noninteractive apt-get remove --purge -y $old_packages >/dev/null 2>&1 || true
            _ok "âœ“ æ—§å†…æ ¸å·²å¸è½½"
        fi
    fi
    
    # å®‰è£…æ–°å†…æ ¸
    echo -e "\nğŸ“¦ æ­£åœ¨å®‰è£…æ–°å†…æ ¸..."
    
    if dpkg -i /tmp/linux-*.deb 2>&1 | tee /tmp/install.log | grep -v "æ­£åœ¨é€‰ä¸­\|æ­£åœ¨è§£åŒ…\|æ­£åœ¨è®¾ç½®"; then
        _ok "âœ“ å†…æ ¸åŒ…å®‰è£…å®Œæˆ"
    else
        if grep -q "error\|é”™è¯¯" /tmp/install.log; then
            _err "âŒ å†…æ ¸å®‰è£…å¤±è´¥ï¼Œè¯·æŸ¥çœ‹: /tmp/install.log"
        fi
    fi
    
    # ä¿®å¤å¯èƒ½çš„ä¾èµ–é—®é¢˜
    apt-get install -f -y >/dev/null 2>&1 || true
    
    # æ›´æ–°å¼•å¯¼
    echo -e "\nğŸ”„ æ­£åœ¨æ›´æ–°GRUBå¼•å¯¼..."
    
    if has update-grub; then
        if update-grub >/dev/null 2>&1; then
            _ok "âœ“ GRUBå·²æ›´æ–°"
        else
            _warn "âš  GRUBæ›´æ–°å¤±è´¥ï¼Œä½†é€šå¸¸ä¸å½±å“ä½¿ç”¨"
        fi
    fi
    
    # æ¸…ç†
    rm -f /tmp/linux-*.deb /tmp/install.log
    
    _title
    echo -e "\033[1;32mâœ… BBRv3 å†…æ ¸å®‰è£…å®Œæˆï¼\033[0m"
    _title
    
    echo -e "\n\033[1;33mâš ï¸  é‡è¦æç¤º:\033[0m"
    echo -e "  1. \033[1må¿…é¡»é‡å¯ç³»ç»Ÿ\033[0mæ‰èƒ½åŠ è½½æ–°å†…æ ¸"
    echo -e "  2. é‡å¯åé€‰æ‹©èœå•é€‰é¡¹ 2 åº”ç”¨ç½‘ç»œä¼˜åŒ–"
    echo -e "  3. ä½¿ç”¨é€‰é¡¹ 3 éªŒè¯BBRv3æ˜¯å¦æˆåŠŸå¯ç”¨"
    
    echo -n -e "\n\033[1;36mğŸ’« æ˜¯å¦ç«‹å³é‡å¯ç³»ç»Ÿï¼Ÿ(y/N): \033[0m"
    read -r reboot_choice
    
    if [[ "$reboot_choice" =~ ^[Yy]$ ]]; then
        echo -e "\n\033[36mç³»ç»Ÿå°†åœ¨ 3 ç§’åé‡å¯...\033[0m"
        sleep 3
        reboot
    else
        echo -e "\n\033[33mè¯·è®°å¾—ç¨åæ‰‹åŠ¨é‡å¯: \033[1msudo reboot\033[0m"
    fi
}

# ============================================================================
# å¸è½½BBRv3å†…æ ¸
# ============================================================================
uninstall_bbrv3_kernel() {
    _title
    echo -e "\033[1;36mğŸ—‘ï¸  å¸è½½ BBRv3 å†…æ ¸\033[0m"
    _title
    
    # æŸ¥æ‰¾å·²å®‰è£…çš„joeyblogå†…æ ¸åŒ…
    local installed_packages=$(dpkg -l 2>/dev/null | grep "joeyblog" | awk '{print $2}' | tr '\n' ' ')
    
    if [ -z "$installed_packages" ]; then
        echo -e "\n\033[33mâš  æœªæ‰¾åˆ°å·²å®‰è£…çš„ joeyblog å†…æ ¸åŒ…\033[0m"
        return 0
    fi
    
    echo -e "\nğŸ“¦ æ£€æµ‹åˆ°ä»¥ä¸‹å†…æ ¸åŒ…:\n"
    echo "$installed_packages" | tr ' ' '\n' | while read -r pkg; do
        [ -n "$pkg" ] && echo -e "  â€¢ \033[33m$pkg\033[0m"
    done
    
    echo -e "\n\033[1;31mâš ï¸  è­¦å‘Š: æ­¤æ“ä½œå°†å¸è½½BBRv3å†…æ ¸ï¼Œç³»ç»Ÿå°†ä½¿ç”¨é»˜è®¤å†…æ ¸\033[0m"
    echo -n -e "\nç¡®è®¤å¸è½½ï¼Ÿ(y/N): "
    read -r confirm
    
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo -e "\n\033[36må·²å–æ¶ˆå¸è½½\033[0m"
        return 0
    fi
    
    echo -e "\nğŸ—‘ï¸  æ­£åœ¨å¸è½½..."
    
    if DEBIAN_FRONTEND=noninteractive apt-get remove --purge -y $installed_packages >/dev/null 2>&1; then
        _ok "âœ“ å†…æ ¸åŒ…å·²å¸è½½"
    else
        _warn "âš  å¸è½½è¿‡ç¨‹å‡ºç°è­¦å‘Šï¼Œä½†å¯èƒ½å·²å®Œæˆ"
    fi
    
    # æ›´æ–°å¼•å¯¼
    if has update-grub; then
        update-grub >/dev/null 2>&1 || true
        _ok "âœ“ GRUBå¼•å¯¼å·²æ›´æ–°"
    fi
    
    # æ¸…ç†å­¤ç«‹åŒ…
    apt-get autoremove -y >/dev/null 2>&1 || true
    
    echo -e "\n\033[1;32mâœ… å¸è½½å®Œæˆ\033[0m"
    echo -e "\n\033[33mâš  å»ºè®®é‡å¯ç³»ç»Ÿä»¥åŠ è½½é»˜è®¤å†…æ ¸\033[0m"
}

# ============================================================================
# åº”ç”¨æ‰€æœ‰ç½‘ç»œä¼˜åŒ–
# ============================================================================
apply_all_optimizations() {
    _title
    echo -e "\033[1;36mâš¡ å¼€å§‹åº”ç”¨ç»ˆæç½‘ç»œä¼˜åŒ–...\033[0m"
    _title
    
    # æ£€æµ‹ç³»ç»Ÿä¿¡æ¯
    detect_system_info
    
    # æ™ºèƒ½æ£€æµ‹ç½‘ç»œå‚æ•°
    detect_rtt
    detect_bandwidth
    
    # è®¡ç®—æé™ç¼“å†²åŒº
    calculate_extreme_buffers
    
    # ç”Ÿæˆé…ç½®æ–‡ä»¶
    generate_sysctl_config
    generate_limits_config
    
    # åº”ç”¨é…ç½®
    apply_sysctl_config
    
    # ç¡¬ä»¶ä¼˜åŒ–
    optimize_nic_hardware
    optimize_multiqueue
    optimize_cpu_performance
    
    _title
    echo -e "\033[1;32mâœ… æ‰€æœ‰ä¼˜åŒ–å·²æˆåŠŸåº”ç”¨ï¼\033[0m"
    _title
    
    # æ˜¾ç¤ºä¼˜åŒ–æ‘˜è¦
    cat <<EOF

ğŸ“Š \033[1;36mä¼˜åŒ–æ‘˜è¦\033[0m
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ–¥ï¸  ç³»ç»Ÿé…ç½®:
  â€¢ CPU: ${SYS[cpu]} æ ¸å¿ƒ
  â€¢ å†…å­˜: ${SYS[mem_gb]} GB
  â€¢ ç½‘å¡: ${SYS[iface]} (${NIC[driver]})

ğŸŒ ç½‘ç»œå‚æ•°:
  â€¢ å¸¦å®½: ${NET[bw]} Mbps
  â€¢ RTTå»¶è¿Ÿ: ${NET[rtt]} ms
  â€¢ BDP: ${NET[bdp_mb]} MB

ğŸ’¾ ç¼“å†²é…ç½®:
  â€¢ TCPæœ€å¤§ç¼“å†²: $((NET[tcp_rmem_max] / 1024 / 1024)) MB
  â€¢ UDPæœ€å¤§ç¼“å†²: $((NET[udp_mem_max] * 4 / 1024)) MB
  â€¢ è¿æ¥é˜Ÿåˆ—: ${NET[backlog]}
  â€¢ Conntrack: ${NET[conntrack]} æ¡

ğŸ“ é…ç½®æ–‡ä»¶:
  â€¢ Sysctl: $SYSCTL_CONF
  â€¢ Limits: $LIMITS_CONF
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

\033[1;33mâš ï¸  é‡è¦æç¤º:\033[0m
  1. é…ç½®å·²æ°¸ä¹…ä¿å­˜ï¼Œé‡å¯åè‡ªåŠ¨ç”Ÿæ•ˆ
  2. å»ºè®®é‡å¯ç³»ç»Ÿä»¥ç¡®ä¿æ‰€æœ‰ä¼˜åŒ–å®Œå…¨ç”Ÿæ•ˆ
  3. ä½¿ç”¨é€‰é¡¹ 3 å¯ä»¥æ£€æŸ¥BBRv3çŠ¶æ€

EOF
}

# ============================================================================
# æ£€æŸ¥BBRv3çŠ¶æ€
# ============================================================================
check_bbr_status() {
    _title
    echo -e "\033[1;36mğŸ“Š BBRv3 çŠ¶æ€æ£€æŸ¥\033[0m"
    _title
    
    local all_ok=true
    
    # ========================================
    # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬
    # ========================================
    echo -e "\n\033[1;35m[1] å†…æ ¸ç‰ˆæœ¬\033[0m"
    local current_kernel=$(uname -r)
    echo -e "  â””â”€ å½“å‰å†…æ ¸: \033[33m$current_kernel\033[0m"
    
    if [[ "$current_kernel" == *"joeyblog"* ]]; then
        echo -e "  â””â”€ \033[32mâœ“ BBRv3å†…æ ¸å·²åŠ è½½\033[0m"
    else
        echo -e "  â””â”€ \033[31mâœ— æœªä½¿ç”¨BBRv3å†…æ ¸\033[0m"
        all_ok=false
    fi
    
    # ========================================
    # æ£€æŸ¥BBRæ¨¡å—
    # ========================================
    echo -e "\n\033[1;35m[2] BBRæ¨¡å—\033[0m"
    
    if modinfo tcp_bbr &>/dev/null; then
        local bbr_version=$(modinfo tcp_bbr 2>/dev/null | awk '/^version:/ {print $2}')
        
        if [ -n "$bbr_version" ]; then
            if [ "$bbr_version" = "3" ]; then
                echo -e "  â””â”€ BBRç‰ˆæœ¬: \033[32mâœ“ v$bbr_version\033[0m"
            else
                echo -e "  â””â”€ BBRç‰ˆæœ¬: \033[33mâš  v$bbr_version (ä¸æ˜¯v3)\033[0m"
                all_ok=false
            fi
        else
            echo -e "  â””â”€ \033[33mâš  æ— æ³•è·å–BBRç‰ˆæœ¬\033[0m"
        fi
        
        # æ˜¾ç¤ºæ¨¡å—è¯¦ç»†ä¿¡æ¯
        local bbr_file=$(modinfo tcp_bbr 2>/dev/null | awk '/^filename:/ {print $2}')
        [ -n "$bbr_file" ] && echo -e "  â””â”€ æ¨¡å—è·¯å¾„: $bbr_file"
    else
        echo -e "  â””â”€ \033[31mâœ— tcp_bbr æ¨¡å—æœªåŠ è½½\033[0m"
        all_ok=false
    fi
    
    # ========================================
    # æ£€æŸ¥å½“å‰é…ç½®
    # ========================================
    echo -e "\n\033[1;35m[3] å½“å‰é…ç½®\033[0m"
    
    local current_cc=$(sysctl -n net.ipv4.tcp_congestion_control 2>/dev/null || echo "unknown")
    local current_qdisc=$(sysctl -n net.core.default_qdisc 2>/dev/null || echo "unknown")
    
    if [ "$current_cc" = "bbr" ]; then
        echo -e "  â””â”€ æ‹¥å¡æ§åˆ¶: \033[32mâœ“ $current_cc\033[0m"
    else
        echo -e "  â””â”€ æ‹¥å¡æ§åˆ¶: \033[31mâœ— $current_cc (åº”ä¸ºbbr)\033[0m"
        all_ok=false
    fi
    
    if [ "$current_qdisc" = "fq" ]; then
        echo -e "  â””â”€ é˜Ÿåˆ—ç®—æ³•: \033[32mâœ“ $current_qdisc\033[0m"
    else
        echo -e "  â””â”€ é˜Ÿåˆ—ç®—æ³•: \033[33mâš  $current_qdisc (æ¨èfq)\033[0m"
    fi
    
    # ========================================
    # æ£€æŸ¥å¯ç”¨ç®—æ³•
    # ========================================
    echo -e "\n\033[1;35m[4] å¯ç”¨ç®—æ³•\033[0m"
    local available_cc=$(sysctl -n net.ipv4.tcp_available_congestion_control 2>/dev/null || echo "")
    echo -e "  â””â”€ $available_cc"
    
    # ========================================
    # æ£€æŸ¥å…³é”®ä¼˜åŒ–å‚æ•°
    # ========================================
    echo -e "\n\033[1;35m[5] å…³é”®ä¼˜åŒ–å‚æ•°\033[0m"
    
    local somaxconn=$(sysctl -n net.core.somaxconn 2>/dev/null || echo 0)
    local rmem_max=$(sysctl -n net.core.rmem_max 2>/dev/null || echo 0)
    local conntrack=$(sysctl -n net.netfilter.nf_conntrack_max 2>/dev/null || echo 0)
    
    echo -e "  â””â”€ somaxconn: $(printf "%'d" $somaxconn)"
    echo -e "  â””â”€ rmem_max: $(( rmem_max / 1024 / 1024 )) MB"
    echo -e "  â””â”€ conntrack_max: $(printf "%'d" $conntrack)"
    
    # ========================================
    # æœ€ç»ˆç»“è®º
    # ========================================
    _title
    
    if $all_ok; then
        echo -e "\n\033[1;32mğŸ‰ BBRv3 å·²å®Œç¾é…ç½®å¹¶æ­£å¸¸è¿è¡Œï¼\033[0m\n"
    else
        echo -e "\n\033[1;33mâš ï¸  BBRv3 æœªå®Œå…¨ç”Ÿæ•ˆï¼Œå¯èƒ½éœ€è¦:\033[0m"
        echo -e "  1. å®‰è£…BBRv3å†…æ ¸ (é€‰é¡¹ 1)"
        echo -e "  2. é‡å¯ç³»ç»Ÿä»¥åŠ è½½æ–°å†…æ ¸"
        echo -e "  3. åº”ç”¨ç½‘ç»œä¼˜åŒ– (é€‰é¡¹ 2)\n"
    fi
}

# ============================================================================
# ä¸»èœå•
# ============================================================================
show_main_menu() {
    clear
    _title
    
    # ASCII Artæ ‡é¢˜
    cat << 'EOF'
    ____  ____  ____       _____ 
   | __ )| __ )|  _ \__   _|___ / 
   |  _ \|  _ \| |_) \ \ / / |_ \ 
   | |_) | |_) |  _ < \ V / ___) |
   |____/|____/|_| \_\ \_/ |____/ 
                                  
   Debian ç»ˆæç½‘ç»œä¼˜åŒ– - æé™æ€§èƒ½ç‰ˆ
EOF
    
    _title
    
    # æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯(å¦‚æœå·²æ£€æµ‹)
    if [ -n "${SYS[kernel]:-}" ]; then
        echo -e "\nğŸ“Š \033[1;36mç³»ç»Ÿä¿¡æ¯\033[0m"
        echo -e "  â€¢ å†…æ ¸: ${SYS[kernel]}"
        echo -e "  â€¢ CPU: ${SYS[cpu]} æ ¸"
        echo -e "  â€¢ å†…å­˜: ${SYS[mem_gb]} GB"
        [ -n "${SYS[iface]:-}" ] && echo -e "  â€¢ ç½‘å¡: ${SYS[iface]}"
    fi
    
    # æ˜¾ç¤ºå½“å‰BBRçŠ¶æ€
    local current_cc=$(sysctl -n net.ipv4.tcp_congestion_control 2>/dev/null || echo "æœªçŸ¥")
    local current_qdisc=$(sysctl -n net.core.default_qdisc 2>/dev/null || echo "æœªçŸ¥")
    
    echo -e "\nğŸŒ \033[1;36må½“å‰é…ç½®\033[0m"
    
    if [ "$current_cc" = "bbr" ]; then
        echo -e "  â€¢ æ‹¥å¡æ§åˆ¶: \033[32m$current_cc âœ“\033[0m"
    else
        echo -e "  â€¢ æ‹¥å¡æ§åˆ¶: \033[33m$current_cc\033[0m"
    fi
    
    echo -e "  â€¢ é˜Ÿåˆ—ç®—æ³•: $current_qdisc"
    
    _title
    
    # èœå•é€‰é¡¹
    echo -e "\n\033[1;33mè¯·é€‰æ‹©æ“ä½œ:\033[0m\n"
    echo -e "  \033[1;36m1.\033[0m ğŸš€ å®‰è£… BBRv3 å†…æ ¸ (è‡ªåŠ¨è·å–æœ€æ–°ç‰ˆ)"
    echo -e "  \033[1;36m2.\033[0m âš¡ åº”ç”¨ç»ˆæç½‘ç»œä¼˜åŒ– (æé™æ€§èƒ½æ¨¡å¼)"
    echo -e "  \033[1;36m3.\033[0m ğŸ“Š æ£€æŸ¥ BBRv3 çŠ¶æ€"
    echo -e "  \033[1;36m4.\033[0m ğŸ—‘ï¸  å¸è½½ BBRv3 å†…æ ¸"
    echo -e "  \033[1;36m0.\033[0m ğŸšª é€€å‡ºè„šæœ¬"
    
    _title
    
    # ä½œè€…ä¿¡æ¯
    echo -e "\n\033[90mç‰ˆæœ¬: $VERSION\033[0m"
    echo -e "\033[90mä½œè€…: æ•´åˆè‡ªç¤¾åŒºä¼˜åŒ–æ–¹æ¡ˆ\033[0m"
    
    _title
    
    echo -n -e "\nè¯·è¾“å…¥é€‰é¡¹ (0-4): "
}

# ============================================================================
# ä¸»ç¨‹åºå…¥å£
# ============================================================================
main() {
    # é¦–æ¬¡è¿è¡Œæ—¶çš„ç³»ç»Ÿæ£€æŸ¥
    check_system
    install_dependencies
    
    # åˆæ¬¡æ£€æµ‹ç³»ç»Ÿä¿¡æ¯
    detect_system_info >/dev/null 2>&1 || true
    
    # ä¸»å¾ªç¯
    while true; do
        show_main_menu
        read -r choice
        
        case "$choice" in
            1)
                # å®‰è£…BBRv3å†…æ ¸
                install_bbrv3_kernel
                echo -e "\n\033[90mæŒ‰å›è½¦é”®ç»§ç»­...\033[0m"
                read -r
                ;;
                
            2)
                # åº”ç”¨ç½‘ç»œä¼˜åŒ–
                apply_all_optimizations
                echo -e "\n\033[90mæŒ‰å›è½¦é”®ç»§ç»­...\033[0m"
                read -r
                ;;
                
            3)
                # æ£€æŸ¥BBRv3çŠ¶æ€
                check_bbr_status
                echo -e "\n\033[90mæŒ‰å›è½¦é”®ç»§ç»­...\033[0m"
                read -r
                ;;
                
            4)
                # å¸è½½BBRv3å†…æ ¸
                uninstall_bbrv3_kernel
                echo -e "\n\033[90mæŒ‰å›è½¦é”®ç»§ç»­...\033[0m"
                read -r
                ;;
                
            0)
                # é€€å‡º
                _title
                echo -e "\n\033[1;36mğŸ‘‹ æ„Ÿè°¢ä½¿ç”¨ BBRv3 ç»ˆæä¼˜åŒ–è„šæœ¬ï¼\033[0m"
                echo -e "\n\033[90må¦‚æœ‰é—®é¢˜ï¼Œè¯·è®¿é—®ç›¸å…³ç¤¾åŒºåé¦ˆ\033[0m\n"
                _title
                exit 0
                ;;
                
            *)
                echo -e "\n\033[31mâŒ æ— æ•ˆçš„é€‰é¡¹ï¼Œè¯·è¾“å…¥ 0-4\033[0m"
                sleep 2
                ;;
        esac
    done
}

# ============================================================================
# è„šæœ¬å¯åŠ¨
# ============================================================================

# æ˜¾ç¤ºå¯åŠ¨æ¨ªå¹…
clear
_title
cat << 'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                            â•‘
â•‘     Debian 12/13 ç»ˆæç½‘ç»œä¼˜åŒ–è„šæœ¬ - BBRv3 æé™ç‰ˆ         â•‘
â•‘                                                            â•‘
â•‘     â€¢ è‡ªåŠ¨å®‰è£…æœ€æ–° BBRv3 å†…æ ¸                             â•‘
â•‘     â€¢ æ™ºèƒ½æ£€æµ‹ç½‘ç»œå‚æ•° (RTT/å¸¦å®½/BDP)                    â•‘
â•‘     â€¢ æé™æ€§èƒ½æ¨¡å¼ä¼˜åŒ– (5å€BDPç¼“å†²)                      â•‘
â•‘     â€¢ è¶…å¤§è¿æ¥é˜Ÿåˆ— (52ä¸‡ somaxconn)                      â•‘
â•‘     â€¢ ä½å»¶è¿Ÿç½‘å¡è°ƒä¼˜ (100Î¼sä¸­æ–­åˆå¹¶)                     â•‘
â•‘     â€¢ CPUæ€§èƒ½æ¨¡å¼ + å¤šé˜Ÿåˆ—è´Ÿè½½å‡è¡¡                        â•‘
â•‘                                                            â•‘
â•‘     é€‚ç”¨: Debian 12/13 (x86_64) çº¯å‡€ç³»ç»Ÿ                 â•‘
â•‘     æ¨¡å¼: é»˜è®¤æé™æ€§èƒ½ (æ— éœ€æ‰‹åŠ¨é€‰æ‹©å‚æ•°)                â•‘
â•‘                                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
_title

echo -e "\n\033[1;33mâš ï¸  ä½¿ç”¨é¡»çŸ¥:\033[0m"
echo -e "  1. æœ¬è„šæœ¬é‡‡ç”¨\033[1mæé™æ€§èƒ½æ¨¡å¼\033[0mï¼Œæ‰€æœ‰å‚æ•°å·²è°ƒè‡³æœ€æ¿€è¿›é…ç½®"
echo -e "  2. ä¼˜åŒ–åŸºäºç¤¾åŒºéªŒè¯çš„æœ€ä½³å®è·µï¼Œç¨³å®šå¯é "
echo -e "  3. è‡ªåŠ¨æ£€æµ‹ç¡¬ä»¶å¹¶åŠ¨æ€è®¡ç®—æœ€ä¼˜å‚æ•°"
echo -e "  4. å»ºè®®åœ¨çº¯å‡€ç³»ç»Ÿä¸Šä½¿ç”¨ï¼Œé¿å…ä¸å…¶ä»–ä¼˜åŒ–å†²çª"

echo -e "\n\033[1;36mğŸ“‹ æ¨èæ“ä½œæµç¨‹:\033[0m"
echo -e "  \033[32mâ‘ \033[0m é€‰æ‹©é€‰é¡¹ 1 å®‰è£… BBRv3 å†…æ ¸"
echo -e "  \033[32mâ‘¡\033[0m é‡å¯ç³»ç»Ÿä»¥åŠ è½½æ–°å†…æ ¸"
echo -e "  \033[32mâ‘¢\033[0m é€‰æ‹©é€‰é¡¹ 2 åº”ç”¨ç»ˆæç½‘ç»œä¼˜åŒ–"
echo -e "  \033[32mâ‘£\033[0m é€‰æ‹©é€‰é¡¹ 3 éªŒè¯ BBRv3 çŠ¶æ€"

_title

echo -n -e "\n\033[1;36mæŒ‰å›è½¦é”®å¼€å§‹...\033[0m"
read -r

# å¯åŠ¨ä¸»ç¨‹åº
main
